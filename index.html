<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Savers Group - Digital Savings System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* ===== RESET & VARIABLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --primary: #1e88e5;
            --primary-dark: #1565c0;
            --success: #2e7d32;
            --warning: #ff9800;
            --danger: #f44336;
            --purple: #9c27b0;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-600: #6c757d;
            --gray-900: #212529;
            
            --bg-primary: #e3f2fd;
            --bg-secondary: white;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --card-bg: white;
            --header-gradient: linear-gradient(135deg, #1e88e5, #64b5f6);
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        [data-theme="dark"] {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --text-primary: #f8f9fa;
            --text-secondary: #adb5bd;
            --border-color: #495057;
            --card-bg: #2d2d2d;
            --header-gradient: linear-gradient(135deg, #0d47a1, #1e88e5);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            line-height: 1.5;
        }
        
        #app {
            max-width: 100%;
            min-height: 100vh;
            background: var(--bg-secondary);
        }
        
        /* ===== HEADER - MOBILE OPTIMIZED ===== */
        .header {
            background: var(--header-gradient);
            color: white;
            padding: 12px 16px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title h1 {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 2px;
        }
        
        .header-title p {
            font-size: 0.75rem;
            opacity: 0.9;
        }
        
        /* ===== MOBILE MENU ===== */
        .menu-toggle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        .menu-dropdown {
            position: absolute;
            top: 70px;
            right: 16px;
            width: 280px;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            display: none;
            z-index: 1000;
        }
        
        .menu-dropdown.active {
            display: block;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            text-decoration: none;
        }
        
        .menu-item:last-child {
            border-bottom: none;
        }
        
        .menu-item i {
            width: 24px;
            text-align: center;
            color: var(--primary);
        }
        
        .menu-item:active {
            background: rgba(30,136,229,0.1);
        }
        
        /* ===== METRICS GRID - MOBILE FIRST ===== */
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            padding: 16px;
        }
        
        @media (min-width: 640px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 1024px) {
            .metrics-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .metric-card {
            background: var(--card-bg);
            padding: 16px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .metric-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: rgba(30,136,229,0.1);
            color: var(--primary);
            flex-shrink: 0;
        }
        
        .metric-content {
            flex: 1;
            min-width: 0;
        }
        
        .metric-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .metric-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* ===== ACTION GRID ===== */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 0 16px 16px;
        }
        
        @media (min-width: 768px) {
            .action-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .action-btn {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: var(--text-primary);
        }
        
        .action-btn i {
            font-size: 24px;
            color: var(--primary);
        }
        
        .action-btn span {
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }
        
        /* ===== MEMBER CARD ===== */
        .member-row {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .member-info {
            flex: 1;
            min-width: 0;
        }
        
        .member-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .member-details {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        /* ===== FORM ELEMENTS ===== */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 16px;
            margin: 16px;
            border: 1px solid var(--border-color);
        }
        
        input, select {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            background: var(--card-bg);
            color: var(--text-primary);
            margin-bottom: 12px;
        }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            margin: 4px 0;
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
            border-radius: 8px;
            width: auto;
        }
        
        /* ===== NOTIFICATION ===== */
        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .notification-dropdown {
            position: absolute;
            top: 70px;
            right: 16px;
            width: 300px;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            display: none;
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .notification-dropdown.active {
            display: block;
        }
        
        /* ===== TRANSACTION ITEM ===== */
        .transaction-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 8px;
        }
        
        .transaction-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        /* ===== STATUS BADGES ===== */
        .status-paid {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .status-due {
            background: #ffebee;
            color: #f44336;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        /* ===== UTILITIES ===== */
        .d-none { display: none; }
        .d-block { display: block; }
        .text-center { text-align: center; }
        .mt-3 { margin-top: 12px; }
        .mb-3 { margin-bottom: 12px; }
        .gap-2 { gap: 8px; }
        
        /* ===== FAB ===== */
        .fab {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(30,136,229,0.4);
            cursor: pointer;
            z-index: 99;
        }
        
        .fab-menu {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow);
            padding: 8px;
            min-width: 200px;
            z-index: 100;
            border: 1px solid var(--border-color);
        }
        
        .fab-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-primary);
        }
        
        .fab-menu-item i {
            width: 20px;
            text-align: center;
        }
        
        .fab-menu-item:active {
            background: rgba(30,136,229,0.1);
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAYYE4-vtk3XXPdvwJ8-BWxiyJiKPASsnM",
            authDomain: "savers-group-app.firebaseapp.com",
            projectId: "savers-group-app",
            storageBucket: "savers-group-app.firebasestorage.app",
            messagingSenderId: "722000008713",
            appId: "1:722000008713:web:5322f5a668bfcd6ff4cad8"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // ===== APP STATE =====
        let members = [];
        let currentUser = null;
        let selectedLoanMemberId = null;
        
        const RULES = {
            MIN_SAVINGS: 200,
            MEMBERSHIP_FEE: 50,
            SOCIAL_FUND: 100,
            INTEREST: 0.10
        };

        // ===== NOTIFICATION MANAGER =====
        const NotificationManager = {
            notifications: [],
            
            init() {
                const saved = localStorage.getItem('notifications');
                this.notifications = saved ? JSON.parse(saved) : [];
            },
            
            add(message, type = 'info') {
                const notification = {
                    id: Date.now(),
                    message,
                    type,
                    timestamp: new Date().toISOString(),
                    read: false
                };
                this.notifications.unshift(notification);
                this.save();
                this.renderBadge();
                this.showToast(message, type);
            },
            
            save() {
                localStorage.setItem('notifications', JSON.stringify(this.notifications));
            },
            
            markAsRead(id) {
                const n = this.notifications.find(n => n.id === id);
                if (n) n.read = true;
                this.save();
                this.renderBadge();
                this.renderDropdown();
            },
            
            markAllRead() {
                this.notifications.forEach(n => n.read = true);
                this.save();
                this.renderBadge();
                this.renderDropdown();
            },
            
            showToast(message, type) {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 16px;
                    right: 16px;
                    background: ${type === 'success' ? '#2e7d32' : type === 'error' ? '#f44336' : '#1e88e5'};
                    color: white;
                    padding: 14px 20px;
                    border-radius: 12px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 9999;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    font-size: 15px;
                    animation: slideDown 0.3s ease;
                    max-width: 400px;
                    margin: 0 auto;
                `;
                toast.innerHTML = `
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    <span style="flex:1;">${message}</span>
                `;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideUp 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },
            
            renderBadge() {
                const badge = document.getElementById('notificationBadge');
                if (badge) {
                    const unread = this.notifications.filter(n => !n.read).length;
                    badge.textContent = unread;
                    badge.style.display = unread > 0 ? 'flex' : 'none';
                }
            },
            
            renderDropdown() {
                const container = document.getElementById('notificationDropdown');
                if (!container) return;
                
                let html = '<div style="padding:16px;border-bottom:1px solid var(--border-color);">';
                html += '<div style="display:flex;justify-content:space-between;align-items:center;">';
                html += '<h4 style="margin:0;font-size:16px;">Notifications</h4>';
                html += '<button onclick="NotificationManager.markAllRead();event.stopPropagation();" style="background:none;border:none;color:var(--primary);font-size:13px;">Mark all read</button>';
                html += '</div></div>';
                
                if (this.notifications.length === 0) {
                    html += '<div style="padding:32px 16px;text-align:center;color:var(--text-secondary);">No notifications</div>';
                } else {
                    this.notifications.slice(0, 5).forEach(n => {
                        html += `
                            <div onclick="NotificationManager.markAsRead(${n.id});event.stopPropagation();" style="padding:16px;border-bottom:1px solid var(--border-color);cursor:pointer;${!n.read ? 'background:rgba(30,136,229,0.05);' : ''}">
                                <div style="display:flex;gap:12px;">
                                    <i class="fas ${n.type === 'success' ? 'fa-check-circle' : n.type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}" 
                                       style="color:${n.type === 'success' ? '#2e7d32' : n.type === 'error' ? '#f44336' : '#1e88e5'};"></i>
                                    <div style="flex:1;">
                                        <div style="font-weight:600;margin-bottom:4px;font-size:14px;">${n.message}</div>
                                        <div style="font-size:11px;color:var(--text-secondary);">${new Date(n.timestamp).toLocaleDateString()}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                container.innerHTML = html;
            }
        };

        // ===== THEME MANAGER =====
        const ThemeManager = {
            init() {
                const theme = localStorage.getItem('theme') || 'light';
                document.documentElement.setAttribute('data-theme', theme);
            },
            
            toggle() {
                const current = document.documentElement.getAttribute('data-theme');
                const newTheme = current === 'light' ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                this.updateUI();
                this.closeAllMenus();
            },
            
            updateUI() {
                const toggle = document.getElementById('themeToggle');
                if (toggle) {
                    const theme = document.documentElement.getAttribute('data-theme');
                    toggle.innerHTML = theme === 'light' 
                        ? '<i class="fas fa-moon"></i><span>Dark Mode</span>' 
                        : '<i class="fas fa-sun"></i><span>Light Mode</span>';
                }
            },
            
            closeAllMenus() {
                document.querySelectorAll('.menu-dropdown.active, .notification-dropdown.active').forEach(el => {
                    el.classList.remove('active');
                });
            }
        };

        // ===== FIREBASE HELPERS =====
        async function loadMembers() {
            try {
                const docRef = db.collection('groups').doc('main');
                const docSnap = await docRef.get();
                if (docSnap.exists) {
                    members = docSnap.data().members || [];
                } else {
                    members = [
                        { 
                            id: "1", 
                            name: "Stephen Mabena", 
                            phone: "0977123456", 
                            savings: 40747.52, 
                            loanPrincipal: 4600, 
                            membershipPaid: true, 
                            socialPaid: true, 
                            pin: '3456',
                            transactions: [
                                { type: 'savings', amount: 40747.52, date: new Date().toISOString(), note: 'Initial balance' },
                                { type: 'loan', amount: 4600, date: new Date().toISOString(), note: 'Existing loan' }
                            ]
                        },
                        { 
                            id: "2", 
                            name: "Peter Mwiinga", 
                            phone: "0977654321", 
                            savings: 27500, 
                            loanPrincipal: 16500, 
                            membershipPaid: true, 
                            socialPaid: true, 
                            pin: '4321',
                            transactions: [
                                { type: 'savings', amount: 27500, date: new Date().toISOString(), note: 'Initial balance' },
                                { type: 'loan', amount: 16500, date: new Date().toISOString(), note: 'Existing loan' }
                            ]
                        }
                    ];
                }
                localStorage.setItem('members', JSON.stringify(members));
            } catch (e) {
                const local = localStorage.getItem('members');
                members = local ? JSON.parse(local) : [];
            }
        }

        async function saveMembers() {
            localStorage.setItem('members', JSON.stringify(members));
            if (!navigator.onLine) return false;
            try {
                await db.collection('groups').doc('main').set({ members });
                return true;
            } catch (e) {
                return false;
            }
        }

        // ===== UI HELPERS =====
        function fmtDate(iso) {
            try {
                return new Date(iso).toLocaleDateString('en-ZM', { 
                    day: 'numeric', month: 'short', year: 'numeric' 
                });
            } catch { 
                return iso; 
            }
        }

        function updateNetworkStatus() {
            const el = document.getElementById('networkStatus');
            if (el) {
                el.textContent = navigator.onLine ? '‚óè Online' : '‚óã Offline';
                el.style.background = navigator.onLine ? 'rgba(255,255,255,0.15)' : '#f44336';
            }
        }

        function closeAllMenus() {
            document.querySelectorAll('.menu-dropdown.active, .notification-dropdown.active').forEach(el => {
                el.classList.remove('active');
            });
        }

        // ===== LOGIN =====
        function showAdminLogin() {
            const form = document.getElementById('loginForm');
            if (form) {
                form.innerHTML = `
                    <input type="text" id="username" value="admin" placeholder="Admin username">
                    <input type="password" id="password" value="ChiSave" placeholder="Admin password">
                    <button class="btn" onclick="login('admin')">üîê ADMIN LOGIN</button>
                `;
            }
        }

        function showMemberLogin() {
            const form = document.getElementById('loginForm');
            if (form) {
                form.innerHTML = `
                    <select id="memberSelect">
                        <option value="">-- Select Your Name --</option>
                        ${members.map(m => `<option value="${m.id}">${m.name}</option>`).join('')}
                    </select>
                    <input type="password" id="memberPass" placeholder="PIN (last 4 digits)">
                    <button class="btn" onclick="login('member')" style="background:#26a69a;">üë§ MEMBER LOGIN</button>
                `;
            }
        }

        function login(type) {
            if (type === 'admin') {
                const user = document.getElementById('username')?.value;
                const pass = document.getElementById('password')?.value;
                if (user === 'admin' && pass === 'ChiSave') {
                    currentUser = { type: 'admin', name: 'Admin' };
                    NotificationManager.add('Welcome back, Admin!', 'success');
                    showAdminDashboard();
                } else {
                    alert('Wrong username or password');
                }
            } else {
                const memberId = document.getElementById('memberSelect')?.value;
                const pass = document.getElementById('memberPass')?.value;
                if (!memberId) { alert('Select your name'); return; }
                const member = members.find(m => m.id === memberId);
                const expectedPin = member.pin || (member.phone || '').slice(-4);
                if (member && pass === expectedPin) {
                    currentUser = { type: 'member', name: member.name, id: member.id };
                    NotificationManager.add(`Welcome back, ${member.name}!`, 'success');
                    showMemberDashboard(member.id);
                } else {
                    alert('Wrong PIN');
                }
            }
        }

        function logout() {
            currentUser = null;
            closeAllMenus();
            showLoginScreen();
        }

        function showLoginScreen() {
            document.getElementById('app').innerHTML = `
                <div class="header">
                    <div class="header-content">
                        <div class="header-title">
                            <h1>üí∞ SAVERS GROUP</h1>
                            <p>Digital Savings System</p>
                        </div>
                        <div id="networkStatus" style="background:rgba(255,255,255,0.15);padding:6px 12px;border-radius:20px;font-size:12px;">
                            Loading...
                        </div>
                    </div>
                </div>
                <div style="padding:16px;">
                    <div class="card" style="max-width:400px;margin:20px auto;">
                        <h2 style="margin-bottom:20px;text-align:center;">Login</h2>
                        <div style="display:flex;gap:12px;margin-bottom:20px;">
                            <button class="btn" onclick="showAdminLogin()" id="adminBtn" style="flex:1;background:#1e88e5;">üëë Admin</button>
                            <button class="btn" onclick="showMemberLogin()" id="memberBtn" style="flex:1;background:#90caf9;">üë§ Member</button>
                        </div>
                        <div id="loginForm">
                            <input type="text" id="username" value="admin" placeholder="Admin username">
                            <input type="password" id="password" value="ChiSave" placeholder="Admin password">
                            <button class="btn" onclick="login('admin')">üîê ADMIN LOGIN</button>
                        </div>
                        <div style="text-align:center;margin-top:30px;color:var(--text-secondary);font-size:12px;">
                            Created by Tha for Chibombo Savers Group
                        </div>
                    </div>
                </div>
            `;
            showAdminLogin();
            updateNetworkStatus();
        }

        // ===== ADMIN DASHBOARD =====
        function showAdminDashboard() {
            const totalSavings = members.reduce((sum, m) => sum + (m.savings || 0), 0);
            const totalLoans = members.reduce((sum, m) => sum + (m.loanPrincipal || 0), 0);
            const active = members.filter(m => m.membershipPaid && m.socialPaid).length;
            
            document.getElementById('app').innerHTML = `
                <div class="header">
                    <div class="header-content">
                        <div class="header-title">
                            <h1>üí∞ SAVERS GROUP</h1>
                            <p>Admin Dashboard</p>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <div id="networkStatus" style="background:rgba(255,255,255,0.15);padding:6px 12px;border-radius:20px;font-size:12px;">
                                ${navigator.onLine ? '‚óè Online' : '‚óã Offline'}
                            </div>
                            
                            <!-- Mobile Menu Toggle -->
                            <div class="menu-toggle" onclick="toggleAdminMenu(event)">
                                <i class="fas fa-ellipsis-v"></i>
                            </div>
                            
                            <!-- Admin Menu Dropdown -->
                            <div id="adminMenu" class="menu-dropdown">
                                <div class="menu-item" onclick="ThemeManager.toggle();closeAllMenus();">
                                    <i class="fas ${document.documentElement.getAttribute('data-theme') === 'light' ? 'fa-moon' : 'fa-sun'}"></i>
                                    <span>${document.documentElement.getAttribute('data-theme') === 'light' ? 'Dark Mode' : 'Light Mode'}</span>
                                </div>
                                <div class="menu-item" onclick="toggleNotifications(event);">
                                    <i class="fas fa-bell"></i>
                                    <span>Notifications</span>
                                    <span id="notificationBadge" class="notification-badge" style="display:none;position:relative;top:0;right:0;margin-left:auto;">0</span>
                                </div>
                                <div class="menu-item" onclick="logout()">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span>Logout</span>
                                </div>
                            </div>
                            
                            <!-- Notification Dropdown -->
                            <div id="notificationDropdown" class="notification-dropdown"></div>
                        </div>
                    </div>
                </div>
                
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-icon"><i class="fas fa-users"></i></div>
                        <div class="metric-content">
                            <div class="metric-label">Members</div>
                            <div id="metricMembers" class="metric-value">${members.length}</div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon"><i class="fas fa-coins"></i></div>
                        <div class="metric-content">
                            <div class="metric-label">Savings</div>
                            <div id="metricSavings" class="metric-value">K${totalSavings.toLocaleString()}</div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon"><i class="fas fa-hand-holding-usd"></i></div>
                        <div class="metric-content">
                            <div class="metric-label">Loans</div>
                            <div id="metricLoans" class="metric-value">K${totalLoans.toLocaleString()}</div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon"><i class="fas fa-check-circle"></i></div>
                        <div class="metric-content">
                            <div class="metric-label">Active</div>
                            <div id="metricActive" class="metric-value">${active}</div>
                        </div>
                    </div>
                </div>
                
                <div class="action-grid">
                    <div class="action-btn" onclick="showAddMember()">
                        <i class="fas fa-user-plus"></i>
                        <span>Add Member</span>
                    </div>
                    <div class="action-btn" onclick="showAddSavings()">
                        <i class="fas fa-piggy-bank"></i>
                        <span>Add Savings</span>
                    </div>
                    <div class="action-btn" onclick="showLoanManagement()">
                        <i class="fas fa-hand-holding-usd"></i>
                        <span>Manage Loans</span>
                    </div>
                    <div class="action-btn" onclick="showAllMembers()">
                        <i class="fas fa-users"></i>
                        <span>View Members</span>
                    </div>
                    <div class="action-btn" onclick="showCollectFees()">
                        <i class="fas fa-check-circle"></i>
                        <span>Collect Fees</span>
                    </div>
                    <div class="action-btn" onclick="showShareAccount()">
                        <i class="fas fa-chart-pie"></i>
                        <span>Share Account</span>
                    </div>
                </div>
                
                <div id="contentArea" style="padding:0 16px;"></div>
            `;
            
            NotificationManager.renderBadge();
            NotificationManager.renderDropdown();
            ThemeManager.updateUI();
            addFloatingActionButton();
        }

        // ===== MEMBER DASHBOARD - FULLY VISIBLE ON MOBILE =====
        function showMemberDashboard(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            const loanInterestDue = (member.loanPrincipal || 0) * RULES.INTEREST;
            const memberSavingsIncl = (member.savings || 0) * (1 + RULES.INTEREST);
            const memberLoanIncl = (member.loanPrincipal || 0) * (1 + RULES.INTEREST);
            const memberNet = memberSavingsIncl - memberLoanIncl;
            
            const transactions = (member.transactions || []).sort((a,b) => new Date(b.date) - new Date(a.date));
            
            let txHtml = '';
            transactions.forEach(t => {
                const icon = t.type === 'savings' ? 'fa-piggy-bank' : 
                            t.type === 'loan' ? 'fa-hand-holding-usd' : 
                            t.type === 'repayment' ? 'fa-undo' : 'fa-check-circle';
                const color = t.type === 'savings' ? '#2e7d32' : 
                             t.type === 'loan' ? '#f44336' : 
                             t.type === 'repayment' ? '#ff9800' : '#9c27b0';
                
                txHtml += `
                    <div class="transaction-item">
                        <div class="transaction-icon" style="background:${color}20;color:${color};">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div style="flex:1;min-width:0;">
                            <div style="display:flex;justify-content:space-between;align-items:start;">
                                <span style="font-weight:600;font-size:14px;">${t.type.toUpperCase()}</span>
                                <span style="font-weight:700;color:${color};font-size:15px;">K${(t.amount||0).toLocaleString()}</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin-top:4px;">
                                <span style="color:var(--text-secondary);font-size:12px;">${fmtDate(t.date)}</span>
                                ${t.interest ? `<span style="color:${color};font-size:12px;">+K${t.interest.toFixed(2)}</span>` : ''}
                            </div>
                            ${t.note ? `<div style="color:var(--text-secondary);font-size:11px;margin-top:4px;">${t.note}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('app').innerHTML = `
                <div class="header">
                    <div class="header-content">
                        <div class="header-title">
                            <h1>üí∞ SAVERS GROUP</h1>
                            <p>${member.name}</p>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <div id="networkStatus" style="background:rgba(255,255,255,0.15);padding:6px 12px;border-radius:20px;font-size:12px;">
                                ${navigator.onLine ? '‚óè Online' : '‚óã Offline'}
                            </div>
                            
                            <!-- Mobile Menu Toggle -->
                            <div class="menu-toggle" onclick="toggleMemberMenu(event)">
                                <i class="fas fa-ellipsis-v"></i>
                            </div>
                            
                            <!-- Member Menu Dropdown -->
                            <div id="memberMenu" class="menu-dropdown">
                                <div class="menu-item" onclick="ThemeManager.toggle();closeAllMenus();">
                                    <i class="fas ${document.documentElement.getAttribute('data-theme') === 'light' ? 'fa-moon' : 'fa-sun'}"></i>
                                    <span>${document.documentElement.getAttribute('data-theme') === 'light' ? 'Dark Mode' : 'Light Mode'}</span>
                                </div>
                                <div class="menu-item" onclick="showEditProfile('${member.id}');closeAllMenus();">
                                    <i class="fas fa-key"></i>
                                    <span>Change PIN</span>
                                </div>
                                <div class="menu-item" onclick="logout()">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span>Logout</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="metrics-grid">
                    <!-- Savings Card -->
                    <div class="metric-card">
                        <div class="metric-icon" style="background:rgba(30,136,229,0.1);">
                            <i class="fas fa-piggy-bank" style="color:#1e88e5;"></i>
                        </div>
                        <div class="metric-content">
                            <div class="metric-label">Savings</div>
                            <div class="metric-value" style="color:#1e88e5;font-size:1.2rem;">K${(member.savings||0).toLocaleString()}</div>
                            <div style="font-size:11px;color:var(--text-secondary);">+10%: K${((member.savings||0)*RULES.INTEREST).toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <!-- Loan Card -->
                    <div class="metric-card">
                        <div class="metric-icon" style="background:rgba(244,67,54,0.1);">
                            <i class="fas fa-hand-holding-usd" style="color:#f44336;"></i>
                        </div>
                        <div class="metric-content">
                            <div class="metric-label">Loan</div>
                            <div class="metric-value" style="color:#f44336;font-size:1.2rem;">K${((member.loanPrincipal||0)*(1+RULES.INTEREST)).toLocaleString()}</div>
                            <div style="font-size:11px;color:var(--text-secondary);">Due: K${loanInterestDue.toFixed(2)}</div>
                        </div>
                    </div>
                    
                    <!-- Net Position Card -->
                    <div class="metric-card">
                        <div class="metric-icon" style="background:rgba(46,125,50,0.1);">
                            <i class="fas fa-calculator" style="color:#2e7d32;"></i>
                        </div>
                        <div class="metric-content">
                            <div class="metric-label">Net Position</div>
                            <div class="metric-value" style="color:#2e7d32;font-size:1.2rem;">K${memberNet.toLocaleString()}</div>
                        </div>
                    </div>
                    
                    <!-- Share Out Card -->
                    <div class="metric-card">
                        <div class="metric-icon" style="background:rgba(255,152,0,0.1);">
                            <i class="fas fa-gift" style="color:#ff9800;"></i>
                        </div>
                        <div class="metric-content">
                            <div class="metric-label">Share Out</div>
                            <div class="metric-value" style="color:#ff9800;font-size:1.2rem;">K${(memberNet*0.1).toFixed(2)}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Status Cards - Full Width -->
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:0 16px 16px;">
                    <div class="${member.membershipPaid ? 'status-paid' : 'status-due'}" style="justify-content:center;">
                        <i class="fas fa-id-card"></i>
                        <span>Membership ${member.membershipPaid ? 'Paid' : 'Due'}</span>
                    </div>
                    <div class="${member.socialPaid ? 'status-paid' : 'status-due'}" style="justify-content:center;">
                        <i class="fas fa-users"></i>
                        <span>Social ${member.socialPaid ? 'Paid' : 'Due'}</span>
                    </div>
                </div>
                
                <!-- Transactions Card -->
                <div class="card" style="margin-top:0;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                        <h3 style="margin:0;font-size:18px;"><i class="fas fa-history"></i> Transactions</h3>
                        <select id="txFilter" onchange="filterMemberTxs('${member.id}')" style="width:120px;padding:8px;margin:0;font-size:14px;">
                            <option value="all">All</option>
                            <option value="savings">Savings</option>
                            <option value="loan">Loans</option>
                            <option value="repayment">Repayments</option>
                            <option value="fee">Fees</option>
                        </select>
                    </div>
                    
                    <div id="memberTxList" style="max-height:400px;overflow-y:auto;">
                        ${txHtml || '<p style="text-align:center;padding:20px;color:var(--text-secondary);">No transactions yet</p>'}
                    </div>
                    
                    <div style="margin-top:20px;padding:16px;background:rgba(30,136,229,0.05);border-radius:12px;text-align:center;">
                        <i class="fas fa-shield-alt" style="color:var(--primary);"></i>
                        <p style="margin:8px 0 0;font-size:12px;color:var(--text-secondary);">
                            View-only history. Contact admin for corrections.
                        </p>
                    </div>
                </div>
            `;
            
            ThemeManager.updateUI();
            updateNetworkStatus();
        }

        // ===== TOGGLE MENUS =====
        function toggleAdminMenu(e) {
            e.stopPropagation();
            closeAllMenus();
            const menu = document.getElementById('adminMenu');
            if (menu) menu.classList.toggle('active');
        }
        
        function toggleMemberMenu(e) {
            e.stopPropagation();
            closeAllMenus();
            const menu = document.getElementById('memberMenu');
            if (menu) menu.classList.toggle('active');
        }
        
        function toggleNotifications(e) {
            e.stopPropagation();
            closeAllMenus();
            const dropdown = document.getElementById('notificationDropdown');
            if (dropdown) {
                dropdown.classList.toggle('active');
                NotificationManager.renderDropdown();
            }
        }

        // Close menus when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.menu-dropdown') && !e.target.closest('.menu-toggle') && !e.target.closest('.notification-dropdown')) {
                closeAllMenus();
            }
        });

        // ===== ADD MEMBER =====
        function showAddMember() {
            document.getElementById('contentArea').innerHTML = `
                <div class="card">
                    <h3 style="margin-bottom:16px;"><i class="fas fa-user-plus"></i> Add New Member</h3>
                    <input type="text" id="newName" placeholder="Full Name">
                    <input type="tel" id="newPhone" placeholder="Phone Number">
                    <input type="number" id="newSavings" value="200" min="200" step="200" placeholder="Initial Savings">
                    <small style="color:var(--text-secondary);display:block;margin-bottom:16px;">Minimum K200, multiples of 200</small>
                    
                    <div style="background:#fff3e0;padding:16px;border-radius:12px;margin-bottom:20px;">
                        <h4 style="margin:0 0 8px;font-size:16px;">One-Time Fees: K150</h4>
                        <p style="margin:4px 0;font-size:14px;">‚Ä¢ Membership: K50</p>
                        <p style="margin:4px 0;font-size:14px;">‚Ä¢ Social Fund: K100</p>
                    </div>
                    
                    <div style="display:flex;gap:12px;">
                        <button class="btn" onclick="addMember()" style="flex:1;">üíæ Save Member</button>
                        <button class="btn" onclick="showAdminDashboard()" style="flex:1;background:#666;">‚Ü©Ô∏è Cancel</button>
                    </div>
                </div>
            `;
        }

        async function addMember() {
            const name = document.getElementById('newName')?.value.trim();
            const phone = document.getElementById('newPhone')?.value.trim();
            const savings = parseInt(document.getElementById('newSavings')?.value) || 200;
            
            if (!name) { alert('Enter name'); return; }
            if (!phone || phone.length < 4) { alert('Enter valid phone'); return; }
            if (savings < 200 || savings % 200 !== 0) { alert('Must be K200+ in multiples of 200'); return; }
            
            const newMember = {
                id: Date.now().toString(),
                name, phone,
                savings, loanPrincipal: 0,
                membershipPaid: false, socialPaid: false,
                pin: phone.slice(-4),
                transactions: [{
                    type: 'savings', amount: savings,
                    date: new Date().toISOString(),
                    note: 'Initial savings'
                }]
            };
            
            members.push(newMember);
            await saveMembers();
            NotificationManager.add('Member added successfully!', 'success');
            showAdminDashboard();
        }

        // ===== VIEW MEMBERS =====
        function showAllMembers() {
            let html = `<h3 style="margin-bottom:16px;padding:0 16px;">All Members (${members.length})</h3>`;
            html += `<div style="padding:0 16px;">`;
            
            members.forEach(member => {
                const initials = member.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                const colors = ['#1e88e5', '#e91e63', '#9c27b0', '#ff9800', '#4caf50', '#f44336'];
                const color = colors[member.name.length % colors.length];
                
                html += `
                    <div class="member-row">
                        <div class="avatar" style="background:${color};">${initials}</div>
                        <div class="member-info">
                            <div class="member-name">${member.name}</div>
                            <div class="member-details">
                                <span>K${(member.savings || 0).toLocaleString()}</span>
                                <span>Loan: K${((member.loanPrincipal||0)*(1+RULES.INTEREST)).toLocaleString()}</span>
                            </div>
                        </div>
                        <button class="btn-sm" onclick="viewMember('${member.id}')" style="padding:8px 12px;">View</button>
                    </div>
                `;
            });
            
            html += `</div>`;
            document.getElementById('contentArea').innerHTML = html;
        }

        function viewMember(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            const txs = (member.transactions || []).sort((a,b) => new Date(b.date) - new Date(a.date));
            
            let txHtml = '<h4 style="margin:20px 0 12px;">Recent Transactions</h4>';
            if (txs.length === 0) {
                txHtml += '<p style="color:var(--text-secondary);text-align:center;padding:20px;">No transactions</p>';
            } else {
                txs.slice(0, 5).forEach(t => {
                    const icon = t.type === 'savings' ? 'fa-piggy-bank' : 
                                t.type === 'loan' ? 'fa-hand-holding-usd' : 
                                t.type === 'repayment' ? 'fa-undo' : 'fa-check-circle';
                    const color = t.type === 'savings' ? '#2e7d32' : 
                                 t.type === 'loan' ? '#f44336' : 
                                 t.type === 'repayment' ? '#ff9800' : '#9c27b0';
                    
                    txHtml += `
                        <div class="transaction-item">
                            <div class="transaction-icon" style="background:${color}20;color:${color};">
                                <i class="fas ${icon}"></i>
                            </div>
                            <div style="flex:1;min-width:0;">
                                <div style="display:flex;justify-content:space-between;">
                                    <span style="font-weight:600;font-size:14px;">${t.type.toUpperCase()}</span>
                                    <span style="font-weight:700;color:${color};">K${(t.amount||0).toLocaleString()}</span>
                                </div>
                                <div style="color:var(--text-secondary);font-size:12px;margin-top:4px;">
                                    ${fmtDate(t.date)} ‚Ä¢ ${t.note || ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            document.getElementById('contentArea').innerHTML = `
                <div class="card">
                    <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">
                        <div class="avatar" style="width:64px;height:64px;font-size:24px;background:${['#1e88e5','#e91e63','#9c27b0','#ff9800','#4caf50','#f44336'][member.name.length % 6]};">
                            ${member.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2)}
                        </div>
                        <div>
                            <h3 style="margin:0;font-size:20px;">${member.name}</h3>
                            <p style="color:var(--text-secondary);margin:4px 0 0;"><i class="fas fa-phone"></i> ${member.phone || 'N/A'}</p>
                        </div>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;">
                        <div style="background:var(--card-bg);padding:16px;border-radius:12px;border:1px solid var(--border-color);">
                            <div style="color:var(--text-secondary);font-size:13px;">Savings</div>
                            <div style="font-size:1.4rem;font-weight:700;color:#1e88e5;">K${(member.savings||0).toLocaleString()}</div>
                        </div>
                        <div style="background:var(--card-bg);padding:16px;border-radius:12px;border:1px solid var(--border-color);">
                            <div style="color:var(--text-secondary);font-size:13px;">Loan</div>
                            <div style="font-size:1.4rem;font-weight:700;color:#f44336;">K${((member.loanPrincipal||0)*(1+RULES.INTEREST)).toLocaleString()}</div>
                        </div>
                    </div>
                    
                    <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px;">
                        <button class="btn-sm" onclick="addSavingsFor('${member.id}')">üí∞ Add Savings</button>
                        <button class="btn-sm" onclick="addLoanFor('${member.id}')">üè¶ Add Loan</button>
                        ${!member.membershipPaid ? `<button class="btn-sm" onclick="collectFee('${member.id}', 'membership')" style="background:#2e7d32;">‚úÖ Membership</button>` : ''}
                        ${!member.socialPaid ? `<button class="btn-sm" onclick="collectFee('${member.id}', 'social')" style="background:#2e7d32;">‚úÖ Social</button>` : ''}
                        <button class="btn-sm" onclick="showAllMembers()" style="background:#666;">‚Ü©Ô∏è Back</button>
                    </div>
                    
                    ${txHtml}
                </div>
            `;
        }

        // ===== ADD SAVINGS =====
        function showAddSavings() {
            let html = `<h3 style="margin-bottom:16px;"><i class="fas fa-piggy-bank"></i> Add Savings</h3>`;
            html += `<select id="savingsMember">`;
            members.forEach(m => html += `<option value="${m.id}">${m.name} (K${(m.savings||0).toLocaleString()})</option>`);
            html += `</select>`;
            html += `<input type="number" id="savingsAmount" value="200" min="200" step="200" placeholder="Amount">`;
            html += `<input type="date" id="savingsDate">`;
            html += `<div style="display:flex;gap:12px;margin-top:16px;">`;
            html += `<button class="btn" onclick="processSavings()" style="flex:1;">‚úÖ Add</button>`;
            html += `<button class="btn" onclick="showAdminDashboard()" style="flex:1;background:#666;">‚Ü©Ô∏è Cancel</button>`;
            html += `</div>`;
            
            document.getElementById('contentArea').innerHTML = `<div class="card">${html}</div>`;
            document.getElementById('savingsDate').value = new Date().toISOString().split('T')[0];
        }

        function addSavingsFor(memberId) {
            showAddSavings();
            setTimeout(() => {
                const select = document.getElementById('savingsMember');
                if (select) select.value = memberId;
            }, 100);
        }

        async function processSavings() {
            const memberId = document.getElementById('savingsMember')?.value;
            const member = members.find(m => m.id === memberId);
            const amount = parseInt(document.getElementById('savingsAmount')?.value) || 200;
            
            if (!member) { alert('Select member'); return; }
            if (amount < 200 || amount % 200 !== 0) { alert('Must be K200+ in multiples of 200'); return; }
            
            const interest = (member.savings || 0) * RULES.INTEREST;
            member.savings = (member.savings || 0) + amount + interest;
            
            const customDate = document.getElementById('savingsDate')?.value 
                ? new Date(document.getElementById('savingsDate').value).toISOString()
                : new Date().toISOString();
            
            member.transactions = member.transactions || [];
            member.transactions.push({ 
                type: 'savings', amount, interest, 
                date: customDate, note: 'Savings deposit' 
            });

            await saveMembers();
            NotificationManager.add(`K${amount} savings added for ${member.name}`, 'success');
            viewMember(member.id);
        }

        // ===== LOAN MANAGEMENT =====
        function showLoanManagement() {
            document.getElementById('contentArea').innerHTML = `
                <div class="card">
                    <h3 style="margin-bottom:16px;"><i class="fas fa-hand-holding-usd"></i> Loan Management</h3>
                    <select id="loanMember">
                        ${members.map(m => `<option value="${m.id}">${m.name} (Loan: K${((m.loanPrincipal||0)*(1+RULES.INTEREST)).toLocaleString()})</option>`).join('')}
                    </select>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:20px;">
                        <button class="btn" onclick="showContractLoan()">‚ûï Contract Loan</button>
                        <button class="btn" onclick="showRepayLoan()">üí≥ Repay Loan</button>
                    </div>
                </div>
            `;
        }

        function showRepayLoan() {
            document.getElementById('contentArea').innerHTML = `
                <div class="card">
                    <h3 style="margin-bottom:16px;"><i class="fas fa-undo"></i> Repay Loan</h3>
                    <select id="repayMember">
                        ${members.map(m => `<option value="${m.id}">${m.name} (Loan: K${((m.loanPrincipal||0)*(1+RULES.INTEREST)).toLocaleString()})</option>`).join('')}
                    </select>
                    <input type="number" id="repayAmount" value="0" min="0" step="100" placeholder="Amount to repay">
                    <div style="display:flex;gap:12px;margin-top:20px;">
                        <button class="btn" onclick="repayLoan()" style="flex:1;">‚úÖ Repay</button>
                        <button class="btn" onclick="showLoanManagement()" style="flex:1;background:#666;">‚Ü©Ô∏è Cancel</button>
                    </div>
                </div>
            `;
        }

        async function repayLoan() {
            const memberId = document.getElementById('repayMember')?.value;
            const amount = parseFloat(document.getElementById('repayAmount')?.value) || 0;
            const member = members.find(m => m.id === memberId);
            
            if (!member) { alert('Select member'); return; }
            if (amount <= 0) { alert('Enter amount > 0'); return; }
            
            member.loanPrincipal = Math.max(0, (member.loanPrincipal || 0) - amount);
            member.transactions = member.transactions || [];
            member.transactions.push({ 
                type: 'repayment', amount, 
                date: new Date().toISOString(), 
                note: 'Loan repayment' 
            });
            
            await saveMembers();
            NotificationManager.add(`K${amount} repayment from ${member.name}`, 'success');
            
            if ((member.loanPrincipal || 0) === 0) {
                member.membershipPaid = true;
                member.socialPaid = true;
                await saveMembers();
                alert(`‚úÖ Loan cleared ‚Äî fees auto-cleared.`);
            }
            
            showLoanManagement();
        }

        function addLoanFor(memberId) {
            showLoanManagement();
            setTimeout(() => {
                const select = document.getElementById('loanMember');
                if (select) { select.value = memberId; showContractLoan(); }
            }, 100);
        }

        function showContractLoan() {
            const memberId = document.getElementById('loanMember')?.value;
            if (!memberId) { alert('Select a member'); return; }
            
            selectedLoanMemberId = memberId;
            const member = members.find(m => m.id === memberId);
            
            document.getElementById('contentArea').innerHTML = `
                <div class="card">
                    <h3 style="margin-bottom:16px;">Contract Loan for ${member.name}</h3>
                    <input type="number" id="loanAmount" value="1000" min="100" step="100" placeholder="Loan Amount">
                    <div style="background:#fff3e0;padding:16px;border-radius:12px;margin:20px 0;">
                        <p style="margin:4px 0;"><strong>10% Interest:</strong> K<span id="loanInterest">100</span></p>
                        <p style="margin:4px 0;"><strong>Total:</strong> K<span id="loanTotal">1100</span></p>
                    </div>
                    <div style="display:flex;gap:12px;">
                        <button class="btn" onclick="contractLoan()" style="flex:1;">‚úÖ Contract</button>
                        <button class="btn" onclick="showLoanManagement()" style="flex:1;background:#666;">‚Ü©Ô∏è Cancel</button>
                    </div>
                </div>
            `;
            
            document.getElementById('loanAmount').oninput = function() {
                const amount = parseFloat(this.value) || 0;
                const interest = amount * RULES.INTEREST;
                document.getElementById('loanInterest').textContent = interest.toFixed(2);
                document.getElementById('loanTotal').textContent = (amount + interest).toFixed(2);
            };
        }

        async function contractLoan() {
            const memberId = selectedLoanMemberId;
            if (!memberId) { alert('No member selected'); return; }
            
            const member = members.find(m => m.id === memberId);
            const amount = parseInt(document.getElementById('loanAmount')?.value) || 0;
            
            if (amount < 100) { alert('Minimum loan is K100'); return; }
            
            member.loanPrincipal = (member.loanPrincipal || 0) + amount;
            member.transactions = member.transactions || [];
            member.transactions.push({ 
                type: 'loan', amount, 
                date: new Date().toISOString(), 
                note: `Loan contracted (10% interest)` 
            });
            
            await saveMembers();
            NotificationManager.add(`K${amount} loan for ${member.name}`, 'success');
            selectedLoanMemberId = null;
            showLoanManagement();
        }

        // ===== COLLECT FEES =====
        function showCollectFees() {
            document.getElementById('contentArea').innerHTML = `
                <div class="card">
                    <h3 style="margin-bottom:16px;"><i class="fas fa-check-circle"></i> Collect Fees</h3>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                        <button class="btn" onclick="showCollectMembership()" style="background:#2e7d32;">
                            <i class="fas fa-id-card"></i> Membership (K50)
                        </button>
                        <button class="btn" onclick="showCollectSocial()" style="background:#2e7d32;">
                            <i class="fas fa-users"></i> Social (K100)
                        </button>
                    </div>
                </div>
            `;
        }

        function showCollectMembership() {
            const unpaid = members.filter(m => !m.membershipPaid);
            let html = `<h3 style="margin-bottom:16px;">Collect Membership Fees (K50)</h3>`;
            
            if (unpaid.length === 0) {
                html += `<p style="text-align:center;padding:20px;">‚úÖ All members have paid!</p>`;
            } else {
                unpaid.forEach(member => {
                    html += `
                        <div class="member-row">
                            <div class="member-info">
                                <div class="member-name">${member.name}</div>
                            </div>
                            <button class="btn-sm" onclick="collectFee('${member.id}', 'membership')" style="background:#2e7d32;">‚úÖ Pay</button>
                        </div>
                    `;
                });
            }
            
            document.getElementById('contentArea').innerHTML = `<div class="card">${html}</div>`;
        }

        function showCollectSocial() {
            const unpaid = members.filter(m => !m.socialPaid);
            let html = `<h3 style="margin-bottom:16px;">Collect Social Fund (K100)</h3>`;
            
            if (unpaid.length === 0) {
                html += `<p style="text-align:center;padding:20px;">‚úÖ All members have paid!</p>`;
            } else {
                unpaid.forEach(member => {
                    html += `
                        <div class="member-row">
                            <div class="member-info">
                                <div class="member-name">${member.name}</div>
                            </div>
                            <button class="btn-sm" onclick="collectFee('${member.id}', 'social')" style="background:#2e7d32;">‚úÖ Pay</button>
                        </div>
                    `;
                });
            }
            
            document.getElementById('contentArea').innerHTML = `<div class="card">${html}</div>`;
        }

        async function collectFee(memberId, type) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            if (type === 'membership') {
                member.membershipPaid = true;
                member.transactions = member.transactions || [];
                member.transactions.push({ 
                    type: 'fee', amount: 50, 
                    date: new Date().toISOString(), 
                    note: 'Membership fee' 
                });
                NotificationManager.add(`K50 membership from ${member.name}`, 'success');
            } else {
                member.socialPaid = true;
                member.transactions = member.transactions || [];
                member.transactions.push({ 
                    type: 'fee', amount: 100, 
                    date: new Date().toISOString(), 
                    note: 'Social fund' 
                });
                NotificationManager.add(`K100 social from ${member.name}`, 'success');
            }
            
            await saveMembers();
            showCollectFees();
        }

        // ===== SHARE ACCOUNT =====
        function showShareAccount() {
            const totalSavings = members.reduce((sum, m) => sum + (m.savings || 0), 0);
            const totalLoans = members.reduce((sum, m) => sum + ((m.loanPrincipal || 0) * (1 + RULES.INTEREST)), 0);
            const netValue = totalSavings - totalLoans;
            const sharePool = netValue * 0.10;
            
            let html = `
                <h3 style="margin-bottom:16px;"><i class="fas fa-chart-pie"></i> Share Account (10%)</h3>
                <div style="background:#e8f5e9;padding:16px;border-radius:12px;margin-bottom:20px;">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                        <div>
                            <span style="color:var(--text-secondary);font-size:13px;">Group Savings</span>
                            <div style="font-size:1.2rem;font-weight:700;color:#1e88e5;">K${totalSavings.toLocaleString()}</div>
                        </div>
                        <div>
                            <span style="color:var(--text-secondary);font-size:13px;">Group Loans</span>
                            <div style="font-size:1.2rem;font-weight:700;color:#f44336;">K${totalLoans.toLocaleString()}</div>
                        </div>
                        <div>
                            <span style="color:var(--text-secondary);font-size:13px;">Net Value</span>
                            <div style="font-size:1.2rem;font-weight:700;color:#2e7d32;">K${netValue.toLocaleString()}</div>
                        </div>
                        <div>
                            <span style="color:var(--text-secondary);font-size:13px;">10% Share Pool</span>
                            <div style="font-size:1.2rem;font-weight:700;color:#ff9800;">K${sharePool.toFixed(2)}</div>
                        </div>
                    </div>
                </div>
            `;
            
            members.forEach(member => {
                const memberSavingsIncl = (member.savings || 0) * (1 + RULES.INTEREST);
                const memberLoanIncl = (member.loanPrincipal || 0) * (1 + RULES.INTEREST);
                const memberNet = memberSavingsIncl - memberLoanIncl;
                const takeHome = netValue !== 0 ? (sharePool * (memberNet / netValue)) : 0;
                
                html += `
                    <div class="member-row">
                        <div class="member-info">
                            <div class="member-name">${member.name}</div>
                            <div class="member-details">
                                <span>Net: K${memberNet.toLocaleString()}</span>
                            </div>
                        </div>
                        <div style="font-weight:700;color:#1e88e5;font-size:16px;">K${takeHome.toFixed(2)}</div>
                    </div>
                `;
            });
            
            document.getElementById('contentArea').innerHTML = `<div class="card">${html}</div>`;
        }

        // ===== FILTER TRANSACTIONS =====
        function filterMemberTxs(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            const filter = document.getElementById('txFilter')?.value || 'all';
            const transactions = (member.transactions || []).sort((a,b) => new Date(b.date) - new Date(a.date));
            const filtered = filter === 'all' ? transactions : transactions.filter(t => t.type === filter);
            
            let html = '';
            filtered.forEach(t => {
                const icon = t.type === 'savings' ? 'fa-piggy-bank' : 
                            t.type === 'loan' ? 'fa-hand-holding-usd' : 
                            t.type === 'repayment' ? 'fa-undo' : 'fa-check-circle';
                const color = t.type === 'savings' ? '#2e7d32' : 
                             t.type === 'loan' ? '#f44336' : 
                             t.type === 'repayment' ? '#ff9800' : '#9c27b0';
                
                html += `
                    <div class="transaction-item">
                        <div class="transaction-icon" style="background:${color}20;color:${color};">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div style="flex:1;min-width:0;">
                            <div style="display:flex;justify-content:space-between;">
                                <span style="font-weight:600;font-size:14px;">${t.type.toUpperCase()}</span>
                                <span style="font-weight:700;color:${color};">K${(t.amount||0).toLocaleString()}</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin-top:4px;">
                                <span style="color:var(--text-secondary);font-size:12px;">${fmtDate(t.date)}</span>
                                ${t.interest ? `<span style="color:${color};font-size:12px;">+K${t.interest.toFixed(2)}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('memberTxList').innerHTML = html || '<p style="text-align:center;padding:20px;color:var(--text-secondary);">No transactions found</p>';
        }

        // ===== EDIT PROFILE =====
        function showEditProfile(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            document.getElementById('app').innerHTML = `
                <div class="header">
                    <div class="header-content">
                        <div class="header-title">
                            <h1>üí∞ SAVERS GROUP</h1>
                            <p>Change PIN</p>
                        </div>
                        <button class="btn-sm" onclick="showMemberDashboard('${member.id}')" style="background:rgba(255,255,255,0.2);">
                            <i class="fas fa-arrow-left"></i> Back
                        </button>
                    </div>
                </div>
                <div style="padding:16px;">
                    <div class="card" style="max-width:400px;margin:0 auto;">
                        <div style="text-align:center;margin-bottom:24px;">
                            <div class="avatar" style="width:80px;height:80px;font-size:32px;margin:0 auto;background:${['#1e88e5','#e91e63','#9c27b0','#ff9800','#4caf50','#f44336'][member.name.length % 6]};">
                                ${member.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2)}
                            </div>
                            <h3 style="margin:12px 0 4px;">${member.name}</h3>
                            <p style="color:var(--text-secondary);font-size:14px;">Current PIN: ${member.phone?.slice(-4) || '----'}</p>
                        </div>
                        
                        <input type="password" id="newPin" placeholder="New 4-digit PIN" maxlength="8">
                        <div style="display:flex;gap:12px;margin-top:20px;">
                            <button class="btn" onclick="saveProfilePin('${member.id}')" style="flex:1;background:#ff9800;">üíæ Save PIN</button>
                            <button class="btn" onclick="showMemberDashboard('${member.id}')" style="flex:1;background:#666;">‚Ü©Ô∏è Cancel</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveProfilePin(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            const pin = document.getElementById('newPin')?.value.trim();
            if (!pin || pin.length < 4) { alert('Enter at least 4 digits'); return; }
            
            member.pin = pin;
            await saveMembers();
            NotificationManager.add('PIN changed successfully!', 'success');
            showMemberDashboard(memberId);
        }

        // ===== FLOATING ACTION BUTTON =====
        function addFloatingActionButton() {
            const existing = document.querySelector('.fab');
            if (existing) existing.remove();
            
            if (!currentUser || currentUser.type !== 'admin') return;
            
            const fab = document.createElement('div');
            fab.className = 'fab';
            fab.innerHTML = '<i class="fas fa-plus"></i>';
            
            let menu = null;
            
            fab.onclick = () => {
                if (menu) { menu.remove(); menu = null; return; }
                
                menu = document.createElement('div');
                menu.className = 'fab-menu';
                menu.innerHTML = `
                    <div class="fab-menu-item" onclick="showAddMember(); this.parentElement.remove();">
                        <i class="fas fa-user-plus" style="color:var(--primary);"></i>
                        <span>Add Member</span>
                    </div>
                    <div class="fab-menu-item" onclick="showAddSavings(); this.parentElement.remove();">
                        <i class="fas fa-piggy-bank" style="color:var(--success);"></i>
                        <span>Add Savings</span>
                    </div>
                    <div class="fab-menu-item" onclick="showLoanManagement(); this.parentElement.remove();">
                        <i class="fas fa-hand-holding-usd" style="color:var(--warning);"></i>
                        <span>Manage Loans</span>
                    </div>
                `;
                
                document.body.appendChild(menu);
                
                setTimeout(() => {
                    document.addEventListener('click', function removeMenu(e) {
                        if (menu && !menu.contains(e.target) && !fab.contains(e.target)) {
                            menu.remove();
                            menu = null;
                            document.removeEventListener('click', removeMenu);
                        }
                    });
                }, 100);
            };
            
            document.body.appendChild(fab);
        }

        // ===== INIT =====
        (async () => {
            NotificationManager.init();
            ThemeManager.init();
            await loadMembers();
            updateNetworkStatus();
            showLoginScreen();
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideDown {
                    from { transform: translateY(-100%); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
                @keyframes slideUp {
                    from { transform: translateY(0); opacity: 1; }
                    to { transform: translateY(-100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        })();
    </script>
</body>
</html>
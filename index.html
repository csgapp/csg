<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Savers Group - Digital Savings System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js for Analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* ===== MODERN UI WITH DARK MODE ===== */
        :root {
            --primary: #1e88e5;
            --primary-dark: #1565c0;
            --primary-light: #64b5f6;
            --success: #2e7d32;
            --warning: #ff9800;
            --danger: #f44336;
            --purple: #9c27b0;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
            
            --bg-primary: #e3f2fd;
            --bg-secondary: white;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --card-bg: white;
            --header-gradient: linear-gradient(90deg, #1e88e5, #64b5f6);
            --shadow: 0 5px 15px rgba(0,0,0,0.1);
            --shadow-hover: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        [data-theme="dark"] {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --text-primary: #f8f9fa;
            --text-secondary: #adb5bd;
            --border-color: #495057;
            --card-bg: #2d2d2d;
            --header-gradient: linear-gradient(90deg, #0d47a1, #1e88e5);
            --shadow: 0 5px 15px rgba(0,0,0,0.3);
            --shadow-hover: 0 8px 25px rgba(0,0,0,0.4);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s ease, color 0.2s ease, border-color 0.2s ease;
        }
        
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        #app {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-secondary);
            border-radius: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        .header {
            background: var(--header-gradient);
            color: white;
            padding: 25px;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            pointer-events: none;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2em;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        
        .content {
            padding: 30px;
        }
        
        /* ===== UNIFIED INPUT STYLING ===== */
        input, select, button, textarea {
            font-family: inherit;
            font-size: 16px;
        }
        
        input[type="text"],
        input[type="password"],
        input[type="tel"],
        input[type="number"],
        input[type="date"],
        select {
            width: 100%;
            padding: 14px;
            margin: 8px 0;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-primary);
            display: block;
            box-sizing: border-box;
        }
        
        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="tel"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
        }
        
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            display: inline-block;
            vertical-align: middle;
        }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
            display: inline-block;
            transition: all 0.2s;
            box-sizing: border-box;
        }
        
        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .login-box {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            max-width: 400px;
            margin: 0 auto;
        }
        
        .member-card {
            background: var(--card-bg);
            padding: 20px;
            margin: 15px 0;
            border-radius: 16px;
            border: 1px solid var(--border-color);
        }
        
        /* ===== MODERN METRIC CARDS ===== */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }
        
        .metric-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
        }
        
        .metric-icon {
            font-size: 24px;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .metric-label {
            color: var(--text-secondary);
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: 700;
            color: var(--primary);
            line-height: 1.2;
        }
        
        /* ===== ACTION BUTTONS ===== */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .action-btn {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-primary);
        }
        
        .action-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            transform: scale(1.05);
        }
        
        .action-btn i {
            font-size: 28px;
        }
        
        .action-btn span {
            font-size: 14px;
            font-weight: 600;
        }
        
        /* ===== DARK MODE TOGGLE ===== */
        .theme-toggle {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 30px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            color: white;
            backdrop-filter: blur(10px);
        }
        
        .theme-toggle i {
            font-size: 16px;
        }
        
        /* ===== SEARCH BAR ===== */
        .search-container {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 15px 20px 15px 50px;
            border: 2px solid var(--border-color);
            border-radius: 30px;
            font-size: 16px;
            background: var(--card-bg);
            color: var(--text-primary);
            transition: all 0.3s;
        }
        
        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(30, 136, 229, 0.1);
            outline: none;
        }
        
        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 18px;
        }
        
        /* ===== AVATAR STYLES ===== */
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            background: var(--primary);
            text-transform: uppercase;
        }
        
        .avatar-large {
            width: 80px;
            height: 80px;
            font-size: 32px;
        }
        
        .avatar-sm {
            width: 32px;
            height: 32px;
            font-size: 14px;
        }
        
        /* ===== MEMBER CARD MODERN ===== */
        .member-card-modern {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.2s;
        }
        
        .member-card-modern:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-hover);
        }
        
        .member-info {
            flex: 1;
        }
        
        .member-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .member-details {
            display: flex;
            gap: 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .member-stats {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .stat-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            background: var(--gray-200);
            color: var(--text-primary);
        }
        
        .stat-badge.success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .stat-badge.warning {
            background: #fff3e0;
            color: #ff9800;
        }
        
        .stat-badge.danger {
            background: #ffebee;
            color: #f44336;
        }
        
        /* ===== PROGRESS BAR ===== */
        .progress-container {
            width: 100%;
            height: 8px;
            background: var(--gray-300);
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        /* ===== TIMELINE ===== */
        .timeline {
            position: relative;
            padding: 20px 0;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 30px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border-color);
        }
        
        .timeline-item {
            position: relative;
            padding-left: 30px;
            margin-bottom: 25px;
        }
        
        .timeline-dot {
            position: absolute;
            left: 24px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--primary);
            border: 2px solid var(--bg-secondary);
            top: 5px;
        }
        
        .timeline-content {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
        }
        
        /* ===== NOTIFICATION CENTER ===== */
        .notification-center {
            position: relative;
        }
        
        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        
        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 350px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow);
            display: none;
            z-index: 1000;
        }
        
        .notification-center:hover .notification-dropdown {
            display: block;
        }
        
        /* ===== FLOATING ACTION BUTTON ===== */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(30, 136, 229, 0.4);
            cursor: pointer;
            transition: all 0.2s;
            z-index: 1000;
        }
        
        .fab:hover {
            transform: scale(1.1);
            background: var(--primary-dark);
        }
        
        /* ===== TOAST NOTIFICATIONS ===== */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        /* ===== RESPONSIVE ===== */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .action-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .member-card-modern {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .fab {
                bottom: 20px;
                right: 20px;
            }
            
            .notification-dropdown {
                width: 300px;
                right: -50px;
            }
        }
        
        @media screen and (max-width: 480px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .action-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .content {
                padding: 15px;
            }
        }
    </style>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAYYE4-vtk3XXPdvwJ8-BWxiyJiKPASsnM",
            authDomain: "savers-group-app.firebaseapp.com",
            projectId: "savers-group-app",
            storageBucket: "savers-group-app.firebasestorage.app",
            messagingSenderId: "722000008713",
            appId: "1:722000008713:web:5322f5a668bfcd6ff4cad8"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        window.db = db;
    </script>
</head>
<body>
    <div id="app"></div>

    <script>
        // ============================================
        // SAVERS GROUP - COMPLETE ENHANCED APPLICATION
        // ============================================
        
        // ===== APP STATE =====
        let members = [];
        let currentUser = null;
        let selectedLoanMemberId = null;
        
        const RULES = {
            MIN_SAVINGS: 200,
            MEMBERSHIP_FEE: 50,
            SOCIAL_FUND: 100,
            INTEREST: 0.10
        };

        // ===== THEME MANAGER =====
        const ThemeManager = {
            init() {
                const savedTheme = localStorage.getItem('theme') || 'light';
                document.documentElement.setAttribute('data-theme', savedTheme);
            },
            
            toggle() {
                const current = document.documentElement.getAttribute('data-theme');
                const newTheme = current === 'light' ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                this.updateIcon();
            },
            
            updateIcon() {
                const icon = document.querySelector('#themeToggle i');
                if (icon) {
                    const theme = document.documentElement.getAttribute('data-theme');
                    icon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
                }
            }
        };

        // ===== NOTIFICATION CENTER =====
        class NotificationCenter {
            constructor() {
                this.notifications = [];
                this.loadNotifications();
            }
            
            loadNotifications() {
                const saved = localStorage.getItem('notifications');
                this.notifications = saved ? JSON.parse(saved) : [];
            }
            
            add(message, type = 'info') {
                const notification = {
                    id: Date.now(),
                    message,
                    type,
                    timestamp: new Date().toISOString(),
                    read: false
                };
                this.notifications.unshift(notification);
                this.save();
                this.render();
                this.showToast(message, type);
            }
            
            save() {
                localStorage.setItem('notifications', JSON.stringify(this.notifications));
            }
            
            markAsRead(id) {
                const notification = this.notifications.find(n => n.id === id);
                if (notification) notification.read = true;
                this.save();
                this.render();
            }
            
            markAllRead() {
                this.notifications.forEach(n => n.read = true);
                this.save();
                this.render();
            }
            
            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.innerHTML = `
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    <span>${message}</span>
                `;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
            
            render() {
                const container = document.getElementById('notificationDropdown');
                if (!container) return;
                
                const unreadCount = this.notifications.filter(n => !n.read).length;
                const badge = document.getElementById('notificationBadge');
                if (badge) {
                    badge.textContent = unreadCount;
                    badge.style.display = unreadCount > 0 ? 'flex' : 'none';
                }
                
                let html = '<div style="padding:15px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;">';
                html += '<h4 style="margin:0;">Notifications</h4>';
                html += '<button onclick="notificationCenter.markAllRead()" style="background:none;border:none;color:var(--primary);cursor:pointer;">Mark all read</button>';
                html += '</div>';
                
                if (this.notifications.length === 0) {
                    html += '<div style="padding:30px;text-align:center;color:var(--text-secondary);">No notifications</div>';
                } else {
                    this.notifications.slice(0, 5).forEach(n => {
                        html += `
                            <div class="notification-item" onclick="notificationCenter.markAsRead(${n.id})" 
                                 style="padding:15px;border-bottom:1px solid var(--border-color);cursor:pointer;${!n.read ? 'background:rgba(30,136,229,0.1);' : ''}">
                                <div style="display:flex;gap:10px;">
                                    <i class="fas ${n.type === 'success' ? 'fa-check-circle' : n.type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}" 
                                       style="color:${n.type === 'success' ? '#2e7d32' : n.type === 'error' ? '#f44336' : '#1e88e5'};"></i>
                                    <div>
                                        <div style="font-weight:600;">${n.message}</div>
                                        <div style="font-size:12px;color:var(--text-secondary);">${new Date(n.timestamp).toLocaleString()}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                container.innerHTML = html;
            }
        }

        // ===== CHART MANAGER =====
        class ChartManager {
            constructor() {
                this.charts = {};
            }
            
            createSavingsChart(canvasId, members) {
                const ctx = document.getElementById(canvasId)?.getContext('2d');
                if (!ctx) return;
                
                if (this.charts[canvasId]) {
                    this.charts[canvasId].destroy();
                }
                
                const data = {
                    labels: members.map(m => m.name.split(' ')[0]),
                    datasets: [{
                        label: 'Savings',
                        data: members.map(m => m.savings || 0),
                        backgroundColor: '#1e88e5',
                        borderRadius: 8
                    }]
                };
                
                this.charts[canvasId] = new Chart(ctx, {
                    type: 'bar',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
            
            createLoanChart(canvasId, members) {
                const ctx = document.getElementById(canvasId)?.getContext('2d');
                if (!ctx) return;
                
                if (this.charts[canvasId]) {
                    this.charts[canvasId].destroy();
                }
                
                const withLoans = members.filter(m => (m.loanPrincipal || 0) > 0);
                
                this.charts[canvasId] = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: withLoans.map(m => m.name.split(' ')[0]),
                        datasets: [{
                            data: withLoans.map(m => m.loanPrincipal || 0),
                            backgroundColor: ['#f44336', '#ff9800', '#ffc107', '#4caf50', '#2196f3']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
        }

        // ===== INITIALIZE MANAGERS =====
        const notificationCenter = new NotificationCenter();
        const chartManager = new ChartManager();
        ThemeManager.init();

        // ===== FIREBASE HELPERS =====
        async function loadMembers() {
            try {
                const docRef = db.collection('groups').doc('main');
                const docSnap = await docRef.get();
                if (docSnap.exists) {
                    members = docSnap.data().members || [];
                } else {
                    members = [
                        { 
                            id: "1", 
                            name: "Stephen Mabena", 
                            phone: "0977123456", 
                            savings: 40747.52, 
                            loanPrincipal: 4600, 
                            loanInterest: 0, 
                            membershipPaid: true, 
                            socialPaid: true, 
                            pin: '3456',
                            transactions: [
                                { type: 'savings', amount: 40747.52, date: new Date().toISOString(), note: 'Initial balance' },
                                { type: 'loan', amount: 4600, date: new Date().toISOString(), note: 'Existing loan' }
                            ]
                        },
                        { 
                            id: "2", 
                            name: "Peter Mwiinga", 
                            phone: "0977654321", 
                            savings: 27500, 
                            loanPrincipal: 16500, 
                            loanInterest: 0, 
                            membershipPaid: true, 
                            socialPaid: true, 
                            pin: '4321',
                            transactions: [
                                { type: 'savings', amount: 27500, date: new Date().toISOString(), note: 'Initial balance' },
                                { type: 'loan', amount: 16500, date: new Date().toISOString(), note: 'Existing loan' }
                            ]
                        }
                    ];
                }
                localStorage.setItem('members', JSON.stringify(members));
            } catch (e) {
                console.error('Error loading members:', e);
                const local = localStorage.getItem('members');
                members = local ? JSON.parse(local) : [];
            }
            setTimeout(processQueue, 1000);
        }

        async function saveMembers() {
            localStorage.setItem('members', JSON.stringify(members));
            if (!navigator.onLine) return false;
            try {
                await db.collection('groups').doc('main').set({ members });
                return true;
            } catch (e) {
                console.error('Error saving members:', e);
                return false;
            }
        }

        // ===== UI HELPERS =====
        function fmtDate(iso) {
            try {
                return new Date(iso).toLocaleDateString(undefined, { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
            } catch (e) { 
                return iso; 
            }
        }

        // ===== OFFLINE QUEUE =====
        function enqueueEdit(edit) {
            const key = 'pendingEdits';
            const q = JSON.parse(localStorage.getItem(key) || '[]');
            q.push(edit);
            localStorage.setItem(key, JSON.stringify(q));
            updateNetworkStatus();
        }

        async function processQueue() {
            if (!navigator.onLine) return;
            const key = 'pendingEdits';
            const q = JSON.parse(localStorage.getItem(key) || '[]');
            if (q.length === 0) return;
            
            q.forEach(item => {
                if (item.type === 'edit-member') {
                    const m = members.find(x => x.id === item.memberId);
                    if (m) Object.assign(m, item.changes);
                } else if (item.type === 'add-member') {
                    members.push(item.member);
                }
            });
            
            const saved = await saveMembers();
            if (saved) {
                localStorage.removeItem(key);
                notificationCenter.add('Pending changes synced', 'success');
                updateAdminMetrics();
            }
        }

        function updateNetworkStatus() {
            const el = document.getElementById('networkStatus');
            if (!el) return;
            
            if (navigator.onLine) {
                el.textContent = 'Online';
                el.style.background = 'rgba(255,255,255,0.15)';
                document.body.classList.remove('offline');
            } else {
                const q = JSON.parse(localStorage.getItem('pendingEdits') || '[]');
                el.textContent = q.length ? `Offline ‚Ä¢ ${q.length} pending` : 'Offline';
                el.style.background = '#f44336';
                document.body.classList.add('offline');
            }
        }

        window.addEventListener('online', () => { 
            updateNetworkStatus(); 
            processQueue(); 
        });
        
        window.addEventListener('offline', updateNetworkStatus);

        // ===== LOGIN FUNCTIONS =====
        function showAdminLogin() {
            document.getElementById('loginForm').innerHTML = `
                <input type="text" id="username" value="admin" placeholder="Admin username">
                <input type="password" id="password" value="ChiSave" placeholder="Admin password">
                <button class="btn" onclick="login('admin')" style="width:100%;">üîê ADMIN LOGIN</button>
            `;
            document.getElementById('adminBtn').style.background = '#1e88e5';
            document.getElementById('memberBtn').style.background = '#90caf9';
        }

        function showMemberLogin() {
            document.getElementById('loginForm').innerHTML = `
                <select id="memberSelect">
                    <option value="">-- Select Your Name --</option>
                    ${members.map(m => `<option value="${m.id}">${m.name}</option>`).join('')}
                </select>
                <input type="password" id="memberPass" placeholder="PIN (last 4 digits of phone)">
                <button class="btn" onclick="login('member')" style="width:100%;background:#26a69a;">üë§ MEMBER LOGIN</button>
            `;
            document.getElementById('memberBtn').style.background = '#1e88e5';
            document.getElementById('adminBtn').style.background = '#90caf9';
        }

        function login(type) {
            if (type === 'admin') {
                const user = document.getElementById('username').value;
                const pass = document.getElementById('password').value;
                if (user === 'admin' && pass === 'ChiSave') {
                    currentUser = { type: 'admin', name: 'Admin' };
                    notificationCenter.add('Welcome back, Admin!', 'success');
                    showAdminDashboard();
                } else {
                    alert('Wrong username or password');
                }
            } else {
                const memberId = document.getElementById('memberSelect').value;
                const pass = document.getElementById('memberPass').value;
                if (!memberId) {
                    alert('Select your name');
                    return;
                }
                const member = members.find(m => m.id === memberId);
                const expectedPin = member.pin || (member.phone || '').slice(-4);
                if (member && pass === expectedPin) {
                    currentUser = { type: 'member', name: member.name, id: member.id };
                    notificationCenter.add(`Welcome back, ${member.name}!`, 'success');
                    showMemberDashboard(member.id);
                } else {
                    alert('Wrong PIN');
                }
            }
        }

        function logout() {
            currentUser = null;
            showLoginScreen();
        }

        function showLoginScreen() {
            document.getElementById('app').innerHTML = `
                <div class="header">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <h1>üí∞ SAVERS GROUP</h1>
                            <p style="opacity:0.9;margin-top:5px;">Digital Savings System</p>
                        </div>
                        <div id="networkStatus" style="background:rgba(255,255,255,0.15);padding:8px 16px;border-radius:8px;font-weight:bold;color:#fff;">
                            Checking...
                        </div>
                    </div>
                </div>
                <div class="content">
                    <div class="login-box">
                        <h2 style="margin-bottom:20px;">Login</h2>
                        <div style="display:flex;gap:10px;margin-bottom:20px;">
                            <button class="btn" onclick="showAdminLogin()" id="adminBtn" style="flex:1;background:#1e88e5;">üëë Admin</button>
                            <button class="btn" onclick="showMemberLogin()" id="memberBtn" style="flex:1;background:#90caf9;">üë§ Member</button>
                        </div>
                        <div id="loginForm">
                            <input type="text" id="username" value="admin" placeholder="Admin username">
                            <input type="password" id="password" value="ChiSave" placeholder="Admin password">
                            <button class="btn" onclick="login('admin')" style="width:100%;">üîê ADMIN LOGIN</button>
                        </div>
                        <div style="text-align:center;margin-top:30px;color:var(--text-secondary);font-size:0.85rem;">
                            Created by Tha for Chibombo Savers Group
                        </div>
                        <button id="installButton" style="display:none; background:#2e7d32; color:white; padding:12px; border-radius:8px; margin-top:20px; width:100%;">
                            üì≤ Install App on Home Screen
                        </button>
                    </div>
                </div>
            `;
            showAdminLogin();
            updateNetworkStatus();
            
            // PWA Install Button
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                const installButton = document.getElementById('installButton');
                if (installButton) installButton.style.display = 'block';
                installButton.onclick = () => {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then(() => {
                        deferredPrompt = null;
                        installButton.style.display = 'none';
                    });
                };
            });
        }

        // ============================================
        // ADMIN DASHBOARD - ENHANCED WITH CHARTS
        // ============================================
        function showAdminDashboard() {
            const totalSavings = members.reduce((sum, m) => sum + (m.savings || 0), 0);
            const totalLoans = members.reduce((sum, m) => sum + (m.loanPrincipal || 0), 0);
            const active = members.filter(m => m.membershipPaid && m.socialPaid).length;
            const totalInterest = members.reduce((sum, m) => sum + ((m.savings || 0) * RULES.INTEREST), 0);
            
            const savingsTrend = 12.5;
            const loansTrend = -5.2;
            const membersTrend = 8.3;
            
            document.getElementById('app').innerHTML = `
                <div class="header">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <h1>üí∞ SAVERS GROUP</h1>
                            <p style="opacity:0.9;margin-top:5px;">Welcome back, Admin üëã</p>
                        </div>
                        <div style="display:flex;gap:15px;align-items:center;">
                            <div id="networkStatus" style="background:rgba(255,255,255,0.15);padding:8px 16px;border-radius:8px;font-weight:bold;color:#fff;">
                                ${navigator.onLine ? 'Online' : 'Offline'}
                            </div>
                            
                            <div class="notification-center">
                                <div style="position:relative;cursor:pointer;">
                                    <i class="fas fa-bell" style="font-size:20px;color:white;"></i>
                                    <span id="notificationBadge" class="notification-badge" style="display:none;">0</span>
                                </div>
                                <div id="notificationDropdown" class="notification-dropdown"></div>
                            </div>
                            
                            <div id="themeToggle" class="theme-toggle" onclick="ThemeManager.toggle()">
                                <i class="fas ${document.documentElement.getAttribute('data-theme') === 'light' ? 'fa-moon' : 'fa-sun'}"></i>
                                <span>${document.documentElement.getAttribute('data-theme') === 'light' ? 'Dark' : 'Light'}</span>
                            </div>
                            
                            <button class="btn" onclick="logout()" style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="content">
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-icon"><i class="fas fa-users"></i></div>
                            <div class="metric-label">Total Members</div>
                            <div id="metricMembers" class="metric-value">${members.length}</div>
                            <div class="metric-trend">
                                <span class="${membersTrend >= 0 ? 'trend-up' : 'trend-down'}">
                                    <i class="fas ${membersTrend >= 0 ? 'fa-arrow-up' : 'fa-arrow-down'}"></i>
                                    ${Math.abs(membersTrend)}%
                                </span> vs last month
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-icon"><i class="fas fa-coins"></i></div>
                            <div class="metric-label">Total Savings</div>
                            <div id="metricSavings" class="metric-value">K${totalSavings.toLocaleString()}</div>
                            <div class="metric-trend">
                                <span class="${savingsTrend >= 0 ? 'trend-up' : 'trend-down'}">
                                    <i class="fas ${savingsTrend >= 0 ? 'fa-arrow-up' : 'fa-arrow-down'}"></i>
                                    ${savingsTrend}%
                                </span> vs last month
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-icon"><i class="fas fa-hand-holding-usd"></i></div>
                            <div class="metric-label">Total Loans</div>
                            <div id="metricLoans" class="metric-value">K${totalLoans.toLocaleString()}</div>
                            <div class="metric-trend">
                                <span class="${loansTrend >= 0 ? 'trend-up' : 'trend-down'}">
                                    <i class="fas ${loansTrend >= 0 ? 'fa-arrow-up' : 'fa-arrow-down'}"></i>
                                    ${Math.abs(loansTrend)}%
                                </span> vs last month
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-icon"><i class="fas fa-chart-line"></i></div>
                            <div class="metric-label">Interest Earned</div>
                            <div class="metric-value">K${totalInterest.toFixed(2)}</div>
                            <div class="metric-trend">This month</div>
                        </div>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px;">
                        <div style="background:var(--card-bg);border-radius:16px;padding:20px;border:1px solid var(--border-color);">
                            <h3 style="margin-bottom:15px;"><i class="fas fa-chart-bar" style="color:var(--primary);"></i> Savings Distribution</h3>
                            <div style="height:250px;">
                                <canvas id="savingsChart"></canvas>
                            </div>
                        </div>
                        
                        <div style="background:var(--card-bg);border-radius:16px;padding:20px;border:1px solid var(--border-color);">
                            <h3 style="margin-bottom:15px;"><i class="fas fa-chart-pie" style="color:var(--primary);"></i> Loan Distribution</h3>
                            <div style="height:250px;">
                                <canvas id="loanChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <h3 style="margin-bottom:15px;"><i class="fas fa-bolt" style="color:var(--primary);"></i> Quick Actions</h3>
                    <div class="action-grid">
                        <div class="action-btn" onclick="showAddMember()">
                            <i class="fas fa-user-plus"></i>
                            <span>Add Member</span>
                        </div>
                        <div class="action-btn" onclick="showAddSavings()">
                            <i class="fas fa-piggy-bank"></i>
                            <span>Add Savings</span>
                        </div>
                        <div class="action-btn" onclick="showLoanManagement()">
                            <i class="fas fa-hand-holding-usd"></i>
                            <span>Manage Loans</span>
                        </div>
                        <div class="action-btn" onclick="showAllMembers()">
                            <i class="fas fa-users"></i>
                            <span>View Members</span>
                        </div>
                        <div class="action-btn" onclick="showCollectFees()">
                            <i class="fas fa-check-circle"></i>
                            <span>Collect Fees</span>
                        </div>
                        <div class="action-btn" onclick="showShareAccount()">
                            <i class="fas fa-chart-pie"></i>
                            <span>Share Account</span>
                        </div>
                        <div class="action-btn" onclick="exportReport()">
                            <i class="fas fa-file-pdf"></i>
                            <span>Export Report</span>
                        </div>
                        <div class="action-btn" onclick="showTimeline()">
                            <i class="fas fa-history"></i>
                            <span>Timeline</span>
                        </div>
                        <div class="action-btn" onclick="showAnalytics()">
                            <i class="fas fa-chart-line"></i>
                            <span>Analytics</span>
                        </div>
                    </div>
                    
                    <div style="margin-top:30px;">
                        <h3 style="margin-bottom:15px;"><i class="fas fa-search"></i> Member Directory</h3>
                        <div class="search-container">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="memberSearch" class="search-input" placeholder="Search by name or phone..." onkeyup="filterMembers()">
                        </div>
                        <div id="memberList" style="max-height:400px;overflow-y:auto;"></div>
                    </div>
                    
                    <div id="contentArea" style="margin-top:30px;"></div>
                </div>
            `;
            
            setTimeout(() => {
                chartManager.createSavingsChart('savingsChart', members);
                chartManager.createLoanChart('loanChart', members);
            }, 100);
            
            displayMemberList();
            notificationCenter.render();
            addFloatingActionButton();
        }

        // ===== MEMBER DIRECTORY WITH SEARCH =====
        function displayMemberList(filteredMembers = null) {
            const list = filteredMembers || members;
            const container = document.getElementById('memberList');
            if (!container) return;
            
            if (list.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-secondary);">No members found</div>';
                return;
            }
            
            const colors = ['#1e88e5', '#e91e63', '#9c27b0', '#ff9800', '#4caf50', '#f44336'];
            
            let html = '';
            list.slice(0, 5).forEach(member => {
                const colorIndex = member.name.length % colors.length;
                const initials = member.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                const loanTotal = (member.loanPrincipal || 0) * (1 + RULES.INTEREST);
                const status = !member.membershipPaid || !member.socialPaid ? 'warning' : 'success';
                const statusText = !member.membershipPaid || !member.socialPaid ? 'Fees Due' : 'Active';
                
                html += `
                    <div class="member-card-modern" onclick="viewMember('${member.id}')" style="cursor:pointer;">
                        <div class="avatar" style="background:${colors[colorIndex]};">
                            ${initials}
                        </div>
                        <div class="member-info">
                            <div class="member-name">${member.name}</div>
                            <div class="member-details">
                                <span><i class="fas fa-phone"></i> ${member.phone || 'N/A'}</span>
                                <span><i class="fas fa-coins"></i> K${(member.savings || 0).toLocaleString()}</span>
                                <span><i class="fas fa-hand-holding-usd"></i> K${loanTotal.toLocaleString()}</span>
                            </div>
                            <div class="progress-container" style="width:200px;">
                                <div class="progress-bar" style="width:${Math.min(100, ((member.savings || 0) / 1000) * 100)}%;"></div>
                            </div>
                        </div>
                        <div class="member-stats">
                            <span class="stat-badge ${status}">
                                <i class="fas ${status === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                                ${statusText}
                            </span>
                        </div>
                    </div>
                `;
            });
            
            if (list.length > 5) {
                html += `<div style="text-align:center;margin-top:10px;">
                    <button class="btn" onclick="showAllMembers()" style="background:none;color:var(--primary);border:1px solid var(--primary);">
                        View all ${list.length} members <i class="fas fa-arrow-right"></i>
                    </button>
                </div>`;
            }
            
            container.innerHTML = html;
        }

        function filterMembers() {
            const searchTerm = document.getElementById('memberSearch').value.toLowerCase();
            if (!searchTerm) {
                displayMemberList(members);
                return;
            }
            
            const filtered = members.filter(m => 
                m.name.toLowerCase().includes(searchTerm) || 
                (m.phone && m.phone.includes(searchTerm))
            );
            displayMemberList(filtered);
        }

        // ===== ADD MEMBER =====
        function showAddMember() {
            document.getElementById('contentArea').innerHTML = `
                <div class="member-card">
                    <h3 style="margin-bottom:20px;"><i class="fas fa-user-plus" style="color:var(--primary);"></i> Add New Member</h3>
                    <div style="width:100%; margin-bottom:10px;">
                        <input type="text" id="newName" placeholder="Full Name">
                    </div>
                    <div style="width:100%; margin-bottom:10px;">
                        <input type="tel" id="newPhone" placeholder="Phone Number">
                    </div>
                    <div style="width:100%; margin-bottom:10px;">
                        <input type="number" id="newSavings" value="200" min="200" step="200" placeholder="Initial Savings">
                    </div>
                    <small style="color:var(--text-secondary);display:block;">Minimum K200, multiples of 200</small>
                    
                    <div style="background:#fff3e0;padding:15px;border-radius:10px;margin:20px 0;">
                        <h4 style="margin:0 0 10px;">One-Time Fees: K150</h4>
                        <p style="margin:5px 0;">‚Ä¢ Membership: K50</p>
                        <p style="margin:5px 0;">‚Ä¢ Social Fund: K100</p>
                    </div>
                    
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button class="btn" onclick="addMember()" style="flex:1;">üíæ Save Member</button>
                        <button class="btn" onclick="showAdminDashboard()" style="flex:1;background:#666;">‚Ü©Ô∏è Cancel</button>
                    </div>
                </div>
            `;
        }

        async function addMember() {
            const name = document.getElementById('newName').value.trim();
            const phone = document.getElementById('newPhone').value.trim();
            const savings = parseInt(document.getElementById('newSavings').value) || 200;
            
            if (!name) {
                alert('Enter name');
                return;
            }
            if (!phone || phone.length < 4) {
                alert('Enter a valid phone number');
                return;
            }
            if (savings < 200 || savings % 200 !== 0) {
                alert('Must be K200+ in multiples of 200');
                return;
            }
            
            const newMember = {
                id: Date.now().toString(),
                name: name,
                phone: phone,
                savings: savings,
                loanPrincipal: 0,
                loanInterest: 0,
                membershipPaid: false,
                socialPaid: false,
                pin: phone.slice(-4),
                transactions: []
            };
            
            if (savings > 0) {
                newMember.transactions.push({ 
                    type: 'savings', 
                    amount: savings, 
                    date: new Date().toISOString(), 
                    note: 'Initial savings' 
                });
            }
            
            members.push(newMember);
            localStorage.setItem('members', JSON.stringify(members));
            
            const saved = await saveMembers();
            if (!saved) {
                enqueueEdit({ type: 'add-member', member: newMember, ts: Date.now() });
                notificationCenter.add('Added locally; will sync when online', 'info');
            } else {
                notificationCenter.add('Member added successfully!', 'success');
            }
            
            showAdminDashboard();
        }

        // ===== VIEW ALL MEMBERS =====
        function showAllMembers() {
            let html = `<h3 style="margin-bottom:20px;"><i class="fas fa-users" style="color:var(--primary);"></i> All Members (${members.length})</h3>`;
            
            members.forEach(member => {
                const loanTotal = (member.loanPrincipal || 0) * (1 + RULES.INTEREST);
                const initials = member.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
                const colors = ['#1e88e5', '#e91e63', '#9c27b0', '#ff9800', '#4caf50', '#f44336'];
                const colorIndex = member.name.length % colors.length;
                
                html += `
                    <div class="member-card-modern">
                        <div class="avatar" style="background:${colors[colorIndex]};">
                            ${initials}
                        </div>
                        <div class="member-info">
                            <div class="member-name">${member.name}</div>
                            <div class="member-details">
                                <span><i class="fas fa-phone"></i> ${member.phone || 'N/A'}</span>
                                <span><i class="fas fa-coins"></i> K${(member.savings || 0).toLocaleString()}</span>
                                <span><i class="fas fa-hand-holding-usd"></i> K${loanTotal.toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="member-stats">
                            <button class="btn" onclick="viewMember('${member.id}')" style="margin:0;padding:10px 20px;">View</button>
                            <button class="btn" onclick="showEditMember('${member.id}')" style="margin:0;padding:10px 20px;background:#ff9800;">Edit</button>
                            <button class="btn" onclick="deleteMember('${member.id}')" style="margin:0;padding:10px 20px;background:#f44336;">Delete</button>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('contentArea').innerHTML = html;
            updateAdminMetrics();
        }

        function viewMember(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            const interest = (member.loanPrincipal || 0) * RULES.INTEREST;
            const txs = (member.transactions || []).slice().sort((a,b) => new Date(b.date) - new Date(a.date));
            
            let txHtml = '<h4 style="margin-top:20px;">Recent Transactions</h4>';
            if (txs.length === 0) {
                txHtml += '<div style="color:var(--text-secondary);padding:20px;text-align:center;">No transactions yet</div>';
            } else {
                txs.slice(0, 10).forEach(t => {
                    const icon = t.type === 'savings' ? 'fa-piggy-bank' : 
                                t.type === 'loan' ? 'fa-hand-holding-usd' : 
                                t.type === 'repayment' ? 'fa-undo' : 'fa-check-circle';
                    
                    const color = t.type === 'savings' ? '#2e7d32' : 
                                 t.type === 'loan' ? '#f44336' : 
                                 t.type === 'repayment' ? '#ff9800' : '#9c27b0';
                    
                    txHtml += `
                        <div style="background:var(--card-bg);padding:15px;border-radius:12px;margin:10px 0;border:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;">
                            <div style="display:flex;align-items:center;gap:15px;">
                                <div style="width:40px;height:40px;border-radius:50%;background:${color}20;display:flex;align-items:center;justify-content:center;">
                                    <i class="fas ${icon}" style="color:${color};"></i>
                                </div>
                                <div>
                                    <div style="font-weight:600;">${t.type.toUpperCase()}</div>
                                    <div style="color:var(--text-secondary);font-size:12px;">${fmtDate(t.date)}</div>
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-weight:700;color:${color};">K${(t.amount || 0).toLocaleString()}</div>
                                <div style="color:var(--text-secondary);font-size:12px;">${t.note || ''}</div>
                            </div>
                        </div>
                    `;
                });
            }

            document.getElementById('contentArea').innerHTML = `
                <div class="member-card">
                    <div style="display:flex;align-items:center;gap:20px;margin-bottom:20px;">
                        <div class="avatar-large" style="background:${['#1e88e5', '#e91e63', '#9c27b0', '#ff9800', '#4caf50', '#f44336'][member.name.length % 6]};">
                            ${member.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2)}
                        </div>
                        <div>
                            <h3 style="margin:0;">${member.name}</h3>
                            <p style="color:var(--text-secondary);margin:5px 0 0;"><i class="fas fa-phone"></i> ${member.phone || 'N/A'}</p>
                        </div>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin:20px 0;">
                        <div style="background:var(--card-bg);padding:20px;border-radius:12px;border:1px solid var(--border-color);">
                            <div style="color:var(--text-secondary);font-size:0.85em;">Savings Balance</div>
                            <div style="font-size:2em;font-weight:700;color:#1e88e5;">K${(member.savings || 0).toLocaleString()}</div>
                        </div>
                        <div style="background:var(--card-bg);padding:20px;border-radius:12px;border:1px solid var(--border-color);">
                            <div style="color:var(--text-secondary);font-size:0.85em;">Loan Balance</div>
                            <div style="font-size:2em;font-weight:700;color:#f44336;">K${((member.loanPrincipal||0) * (1 + RULES.INTEREST)).toLocaleString()}</div>
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:10px;margin-top:20px;flex-wrap:wrap;">
                        <button class="btn" onclick="addSavingsFor('${member.id}')">üí∞ Add Savings</button>
                        <button class="btn" onclick="addLoanFor('${member.id}')">üè¶ Add Loan</button>
                        ${!member.membershipPaid ? `<button class="btn" onclick="collectFee('${member.id}', 'membership')" style="background:#2e7d32;">‚úÖ Pay K50 Membership</button>` : ''}
                        ${!member.socialPaid ? `<button class="btn" onclick="collectFee('${member.id}', 'social')" style="background:#2e7d32;">‚úÖ Pay K100 Social</button>` : ''}
                        <button class="btn" onclick="showEditMember('${member.id}')" style="background:#ff9800;">‚úèÔ∏è Edit</button>
                        <button class="btn" onclick="showAllMembers()" style="background:#666;">‚Ü©Ô∏è Back</button>
                    </div>
                    
                    <div style="margin-top:30px;">
                        <h4>Transaction History</h4>
                        ${txHtml}
                    </div>
                </div>
            `;
        }

        async function deleteMember(memberId) {
            if (confirm('Delete this member? This cannot be undone.')) {
                members = members.filter(m => m.id !== memberId);
                await saveMembers();
                notificationCenter.add('Member deleted', 'info');
                showAllMembers();
            }
        }

        // ===== ADD SAVINGS =====
        function showAddSavings() {
            let html = `<h3 style="margin-bottom:20px;"><i class="fas fa-piggy-bank" style="color:var(--primary);"></i> Add Savings</h3>`;
            
            html += `<div style="width:100%; margin-bottom:10px;">`;
            html += `<select id="savingsMember" style="width:100%; padding:14px; border:2px solid var(--border-color); border-radius:8px; background:var(--card-bg); color:var(--text-primary);">`;
            members.forEach(m => {
                html += `<option value="${m.id}">${m.name} (K${(m.savings || 0).toLocaleString()})</option>`;
            });
            html += `</select>`;
            html += `</div>`;
            
            html += `<div style="width:100%; margin-bottom:10px;">`;
            html += `<input type="number" id="savingsAmount" value="200" min="200" step="200" placeholder="Amount" style="width:100%; padding:14px; border:2px solid var(--border-color); border-radius:8px; background:var(--card-bg); color:var(--text-primary);">`;
            html += `</div>`;
            
            html += `<div style="width:100%; margin-bottom:10px;">`;
            html += `<input type="date" id="savingsDate" style="width:100%; padding:14px; border:2px solid var(--border-color); border-radius:8px; background:var(--card-bg); color:var(--text-primary);">`;
            html += `</div>`;
            
            html += `<div style="display:flex;gap:10px;margin-top:20px;">`;
            html += `<button class="btn" onclick="processSavings()" style="flex:1;">‚úÖ Add Savings</button>`;
            html += `<button class="btn" onclick="showAdminDashboard()" style="flex:1;background:#666;">‚Ü©Ô∏è Cancel</button>`;
            html += `</div>`;
            
            document.getElementById('contentArea').innerHTML = html;
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('savingsDate').value = today;
        }

        function addSavingsFor(memberId) {
            showAddSavings();
            setTimeout(() => {
                document.getElementById('savingsMember').value = memberId;
            }, 100);
        }

        async function processSavings() {
            const memberId = document.getElementById('savingsMember').value;
            const member = members.find(m => m.id === memberId);
            const amount = parseInt(document.getElementById('savingsAmount').value) || 200;
            
            if (!member) {
                alert('Select a member');
                return;
            }
            
            if (amount < 200 || amount % 200 !== 0) {
                alert('Must be K200+ in multiples of 200');
                return;
            }
            
            const interest = (member.savings || 0) * RULES.INTEREST;
            member.savings = (member.savings || 0) + amount + interest;
            
            const customDate = document.getElementById('savingsDate').value 
                ? new Date(document.getElementById('savingsDate').value).toISOString()
                : new Date().toISOString();
            
            member.transactions = member.transactions || [];
            member.transactions.push({ 
                type: 'savings', 
                amount: amount, 
                interest: interest, 
                date: customDate,
                note: 'Savings deposit' 
            });

            await saveMembers();
            notificationCenter.add(`K${amount} savings added for ${member.name}`, 'success');
            updateAdminMetrics();
            viewMember(memberId);
        }

        // ===== LOAN MANAGEMENT =====
        function showLoanManagement() {
            document.getElementById('contentArea').innerHTML = `
                <div class="member-card">
                    <h3 style="margin-bottom:20px;"><i class="fas fa-hand-holding-usd" style="color:var(--primary);"></i> Loan Management</h3>
                    <div style="width:100%; margin-bottom:10px;">
                        <select id="loanMember" style="width:100%; padding:14px; border:2px solid var(--border-color); border-radius:8px; background:var(--card-bg); color:var(--text-primary);">
                            ${members.map(m => {
                                const loanTotal = (m.loanPrincipal || 0) * (1 + RULES.INTEREST);
                                return `<option value="${m.id}">${m.name} (Loan: K${loanTotal.toLocaleString()})</option>`;
                            }).join('')}
                        </select>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:20px;">
                        <button class="btn" onclick="showContractLoan()">‚ûï Contract Loan</button>
                        <button class="btn" onclick="showRepayLoan()">üí≥ Repay Loan</button>
                    </div>
                </div>
            `;
        }

        function showRepayLoan() {
            document.getElementById('contentArea').innerHTML = `
                <div class="member-card">
                    <h3 style="margin-bottom:20px;"><i class="fas fa-undo" style="color:var(--primary);"></i> Repay Loan</h3>
                    <div style="width:100%; margin-bottom:10px;">
                        <select id="repayMember" style="width:100%; padding:14px; border:2px solid var(--border-color); border-radius:8px; background:var(--card-bg); color:var(--text-primary);">
                            ${members.map(m => {
                                const loanTotal = (m.loanPrincipal || 0) * (1 + RULES.INTEREST);
                                return `<option value="${m.id}">${m.name} (Loan: K${loanTotal.toLocaleString()})</option>`;
                            }).join('')}
                        </select>
                    </div>
                    <div style="width:100%; margin-bottom:10px;">
                        <input type="number" id="repayAmount" value="0" min="0" step="100" placeholder="Amount to repay" style="width:100%; padding:14px; border:2px solid var(--border-color); border-radius:8px; background:var(--card-bg); color:var(--text-primary);">
                    </div>
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button class="btn" onclick="repayLoan()" style="flex:1;">‚úÖ Repay</button>
                        <button class="btn" onclick="showLoanManagement()" style="flex:1;background:#666;">‚Ü©Ô∏è Cancel</button>
                    </div>
                </div>
            `;
        }

        async function repayLoan() {
            const memberId = document.getElementById('repayMember').value;
            const amount = parseFloat(document.getElementById('repayAmount').value) || 0;
            const member = members.find(m => m.id === memberId);
            
            if (!member) { alert('Select member'); return; }
            if (amount <= 0) { alert('Enter amount > 0'); return; }
            
            member.loanPrincipal = Math.max(0, (member.loanPrincipal || 0) - amount);
            member.transactions = member.transactions || [];
            member.transactions.push({ 
                type: 'repayment', 
                amount: amount, 
                date: new Date().toISOString(), 
                note: 'Loan repayment' 
            });
            
            await saveMembers();
            notificationCenter.add(`K${amount} repayment from ${member.name}`, 'success');
            
            if ((member.loanPrincipal || 0) === 0) {
                member.membershipPaid = true;
                member.socialPaid = true;
                member.transactions.push({ 
                    type: 'fee-clear', 
                    amount: 0, 
                    date: new Date().toISOString(), 
                    note: 'Loan cleared ‚Äî fees auto-cleared' 
                });
                await saveMembers();
                alert(`‚úÖ ${member.name}'s loan cleared ‚Äî fees auto-cleared.`);
            }
            
            updateAdminMetrics();
            showLoanManagement();
        }

        function addLoanFor(memberId) {
            showLoanManagement();
            setTimeout(() => {
                document.getElementById('loanMember').value = memberId;
                showContractLoan();
            }, 100);
        }

        function showContractLoan() {
            const memberId = document.getElementById('loanMember').value;
            if (!memberId) {
                alert('Select a member first');
                return;
            }
            
            selectedLoanMemberId = memberId;
            const member = members.find(m => m.id === memberId);
            
            document.getElementById('contentArea').innerHTML = `
                <div class="member-card">
                    <h3 style="margin-bottom:20px;"><i class="fas fa-file-signature" style="color:var(--primary);"></i> Contract Loan for ${member.name}</h3>
                    <div style="width:100%; margin-bottom:10px;">
                        <input type="number" id="loanAmount" value="1000" min="100" step="100" placeholder="Loan Amount" style="width:100%; padding:14px; border:2px solid var(--border-color); border-radius:8px; background:var(--card-bg); color:var(--text-primary);">
                    </div>
                    <div style="background:#fff3e0;padding:15px;border-radius:10px;margin:20px 0;">
                        <p style="margin:5px 0;"><strong>10% Interest:</strong> K<span id="loanInterest">100</span></p>
                        <p style="margin:5px 0;"><strong>Total Repayment:</strong> K<span id="loanTotal">1100</span></p>
                    </div>
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button class="btn" onclick="contractLoan()" style="flex:1;">‚úÖ Contract Loan</button>
                        <button class="btn" onclick="showLoanManagement()" style="flex:1;background:#666;">‚Ü©Ô∏è Cancel</button>
                    </div>
                </div>
            `;
            
            document.getElementById('loanAmount').oninput = function() {
                const amount = parseFloat(this.value) || 0;
                const interest = amount * RULES.INTEREST;
                document.getElementById('loanInterest').textContent = interest.toFixed(2);
                document.getElementById('loanTotal').textContent = (amount + interest).toFixed(2);
            };
        }

        async function contractLoan() {
            const memberId = selectedLoanMemberId;
            if (!memberId) {
                alert('No member selected');
                return;
            }
            
            const member = members.find(m => m.id === memberId);
            const amount = parseInt(document.getElementById('loanAmount').value) || 0;
            
            if (amount < 100) {
                alert('Minimum loan amount is K100');
                return;
            }
            
            member.loanPrincipal = (member.loanPrincipal || 0) + amount;
            member.transactions = member.transactions || [];
            member.transactions.push({ 
                type: 'loan', 
                amount: amount, 
                date: new Date().toISOString(), 
                note: `Loan contracted (10% interest applied)` 
            });
            
            await saveMembers();
            notificationCenter.add(`K${amount} loan contracted for ${member.name}`, 'success');
            selectedLoanMemberId = null;
            updateAdminMetrics();
            showLoanManagement();
        }

        // ===== COLLECT FEES =====
        function showCollectFees() {
            document.getElementById('contentArea').innerHTML = `
                <div class="member-card">
                    <h3 style="margin-bottom:20px;"><i class="fas fa-check-circle" style="color:var(--primary);"></i> Collect Fees</h3>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;">
                        <button class="btn" onclick="showCollectMembership()" style="background:#2e7d32;">
                            <i class="fas fa-id-card"></i> Membership (K50)
                        </button>
                        <button class="btn" onclick="showCollectSocial()" style="background:#2e7d32;">
                            <i class="fas fa-users"></i> Social Fund (K100)
                        </button>
                    </div>
                </div>
            `;
        }

        function showCollectMembership() {
            const unpaid = members.filter(m => !m.membershipPaid);
            let html = `<h3 style="margin-bottom:20px;"><i class="fas fa-id-card" style="color:var(--primary);"></i> Collect Membership Fees (K50)</h3>`;
            
            if (unpaid.length === 0) {
                html += `<div style="padding:40px;text-align:center;color:var(--text-secondary);">‚úÖ All members have paid!</div>`;
            } else {
                unpaid.forEach(member => {
                    html += `
                        <div class="member-card-modern">
                            <div class="avatar" style="background:${['#1e88e5', '#e91e63', '#9c27b0', '#ff9800', '#4caf50', '#f44336'][member.name.length % 6]};">
                                ${member.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2)}
                            </div>
                            <div class="member-info">
                                <div class="member-name">${member.name}</div>
                                <div class="member-details">
                                    <span><i class="fas fa-phone"></i> ${member.phone || 'N/A'}</span>
                                </div>
                            </div>
                            <div class="member-stats">
                                <button class="btn" onclick="collectFee('${member.id}', 'membership')" style="margin:0;background:#2e7d32;">
                                    ‚úÖ Mark Paid
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('contentArea').innerHTML = html;
        }

        function showCollectSocial() {
            const unpaid = members.filter(m => !m.socialPaid);
            let html = `<h3 style="margin-bottom:20px;"><i class="fas fa-users" style="color:var(--primary);"></i> Collect Social Fund Fees (K100)</h3>`;
            
            if (unpaid.length === 0) {
                html += `<div style="padding:40px;text-align:center;color:var(--text-secondary);">‚úÖ All members have paid!</div>`;
            } else {
                unpaid.forEach(member => {
                    html += `
                        <div class="member-card-modern">
                            <div class="avatar" style="background:${['#1e88e5', '#e91e63', '#9c27b0', '#ff9800', '#4caf50', '#f44336'][member.name.length % 6]};">
                                ${member.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2)}
                            </div>
                            <div class="member-info">
                                <div class="member-name">${member.name}</div>
                                <div class="member-details">
                                    <span><i class="fas fa-phone"></i> ${member.phone || 'N/A'}</span>
                                </div>
                            </div>
                            <div class="member-stats">
                                <button class="btn" onclick="collectFee('${member.id}', 'social')" style="margin:0;background:#2e7d32;">
                                    ‚úÖ Mark Paid
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('contentArea').innerHTML = html;
        }

        async function collectFee(memberId, type) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            if (type === 'membership') {
                member.membershipPaid = true;
                member.transactions = member.transactions || [];
                member.transactions.push({ 
                    type: 'fee', 
                    amount: 50, 
                    date: new Date().toISOString(), 
                    note: 'Membership fee' 
                });
                notificationCenter.add(`K50 membership fee collected from ${member.name}`, 'success');
            } else {
                member.socialPaid = true;
                member.transactions = member.transactions || [];
                member.transactions.push({ 
                    type: 'fee', 
                    amount: 100, 
                    date: new Date().toISOString(), 
                    note: 'Social fund' 
                });
                notificationCenter.add(`K100 social fund collected from ${member.name}`, 'success');
            }
            
            await saveMembers();
            updateAdminMetrics();
            
            const header = document.querySelector('#contentArea h3');
            if (header && header.textContent.includes('Membership')) {
                showCollectMembership();
            } else if (header && header.textContent.includes('Social')) {
                showCollectSocial();
            } else {
                viewMember(memberId);
            }
        }

        // ===== SHARE ACCOUNT =====
        function showShareAccount() {
            const totalSavings = members.reduce((sum, m) => sum + (m.savings || 0), 0);
            const totalLoans = members.reduce((sum, m) => sum + ((m.loanPrincipal || 0) * (1 + RULES.INTEREST)), 0);
            const netValue = totalSavings - totalLoans;
            const sharePool = netValue * 0.10;
            
            let html = `
                <h3 style="margin-bottom:20px;"><i class="fas fa-chart-pie" style="color:var(--primary);"></i> Share Account (10% Share Out)</h3>
                <div style="margin:10px 0;">
                    <button class="btn" onclick="exportShareCSV()" style="background:#2e7d32;">
                        <i class="fas fa-file-csv"></i> Export CSV
                    </button>
                </div>
                <div style="background:#e8f5e9;padding:20px;border-radius:16px;margin:20px 0;border:1px solid #c8e6c9;">
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;">
                        <div>
                            <div style="color:var(--text-secondary);">Total Group Savings</div>
                            <div style="font-size:1.4em;font-weight:700;color:#1e88e5;">K${totalSavings.toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color:var(--text-secondary);">Total Group Loans</div>
                            <div style="font-size:1.4em;font-weight:700;color:#f44336;">K${totalLoans.toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color:var(--text-secondary);">Net Value</div>
                            <div style="font-size:1.4em;font-weight:700;color:#2e7d32;">K${netValue.toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color:var(--text-secondary);">10% Share Pool</div>
                            <div style="font-size:1.4em;font-weight:700;color:#ff9800;">K${sharePool.toFixed(2)}</div>
                        </div>
                    </div>
                </div>
            `;
            
            members.forEach(member => {
                const memberSavingsIncl = (member.savings || 0) * (1 + RULES.INTEREST);
                const memberLoanIncl = (member.loanPrincipal || 0) * (1 + RULES.INTEREST);
                const memberNet = memberSavingsIncl - memberLoanIncl;
                const shareFraction = netValue !== 0 ? (memberNet / netValue) : 0;
                const takeHome = sharePool * shareFraction;
                
                html += `
                    <div class="member-card-modern">
                        <div class="avatar" style="background:${['#1e88e5', '#e91e63', '#9c27b0', '#ff9800', '#4caf50', '#f44336'][member.name.length % 6]};">
                            ${member.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2)}
                        </div>
                        <div class="member-info">
                            <div class="member-name">${member.name}</div>
                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-top:10px;">
                                <div>
                                    <span style="color:var(--text-secondary);">Savings (incl.)</span>
                                    <div style="font-weight:600;">K${memberSavingsIncl.toLocaleString()}</div>
                                </div>
                                <div>
                                    <span style="color:var(--text-secondary);">Loan (incl.)</span>
                                    <div style="font-weight:600;">K${memberLoanIncl.toLocaleString()}</div>
                                </div>
                                <div>
                                    <span style="color:var(--text-secondary);">Net Position</span>
                                    <div style="font-weight:600;">K${memberNet.toLocaleString()}</div>
                                </div>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="color:var(--text-secondary);font-size:0.85em;">Share Payout</div>
                            <div style="font-size:1.4em;font-weight:700;color:#1e88e5;">K${takeHome.toFixed(2)}</div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('contentArea').innerHTML = html;
            updateAdminMetrics();
        }

        function exportShareCSV() {
            const totalSavings = members.reduce((sum, m) => sum + (m.savings || 0), 0);
            const totalLoans = members.reduce((sum, m) => sum + ((m.loanPrincipal || 0) * (1 + RULES.INTEREST)), 0);
            const netValue = totalSavings - totalLoans;
            const sharePool = netValue * 0.10;
            
            let rows = [['Name', 'Savings (incl.)', 'Loan (incl.)', 'Net Position', 'Share Payout']];
            
            members.forEach(member => {
                const memberSavingsIncl = (member.savings || 0) * (1 + RULES.INTEREST);
                const memberLoanIncl = (member.loanPrincipal || 0) * (1 + RULES.INTEREST);
                const memberNet = memberSavingsIncl - memberLoanIncl;
                const shareFraction = netValue !== 0 ? (memberNet / netValue) : 0;
                const takeHome = sharePool * shareFraction;
                
                rows.push([
                    member.name,
                    memberSavingsIncl.toFixed(2),
                    memberLoanIncl.toFixed(2),
                    memberNet.toFixed(2),
                    takeHome.toFixed(2)
                ]);
            });

            const csv = rows.map(r => r.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')).join('\r\n');
            const filename = `Savers_Share_Out_${new Date().toISOString().slice(0,10)}.csv`;
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
            
            notificationCenter.add('Share account CSV exported', 'success');
        }

        // ===== EDIT MEMBER (ADMIN) =====
        function showEditMember(memberId) {
            if (!currentUser || currentUser.type !== 'admin') {
                alert('Only Admins can edit members');
                return;
            }
            
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            document.getElementById('contentArea').innerHTML = `
                <div class="member-card">
                    <h3 style="margin-bottom:20px;"><i class="fas fa-edit" style="color:var(--primary);"></i> Edit ${member.name}</h3>
                    
                    <div style="width:100%; margin-bottom:10px;">
                        <input type="text" id="editName" value="${member.name}" placeholder="Full Name">
                    </div>
                    
                    <div style="width:100%; margin-bottom:10px;">
                        <input type="tel" id="editPhone" value="${member.phone || ''}" placeholder="Phone Number">
                    </div>
                    
                    <div style="width:100%; margin-bottom:10px;">
                        <input type="text" id="editPin" value="${member.pin || ''}" placeholder="PIN (4+ digits)">
                    </div>
                    
                    <div style="width:100%; margin-bottom:10px;">
                        <input type="number" id="editSavings" value="${member.savings || 0}" min="0" placeholder="Savings">
                    </div>
                    
                    <div style="width:100%; margin-bottom:10px;">
                        <input type="number" id="editLoan" value="${member.loanPrincipal || 0}" min="0" placeholder="Loan Principal">
                    </div>
                    
                    <div style="display:flex;gap:20px;margin:15px 0;">
                        <label style="display:flex;align-items:center;">
                            <input id="editMembership" type="checkbox" ${member.membershipPaid ? 'checked' : ''}> Membership paid
                        </label>
                        <label style="display:flex;align-items:center;">
                            <input id="editSocial" type="checkbox" ${member.socialPaid ? 'checked' : ''}> Social paid
                        </label>
                    </div>
                    
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button class="btn" onclick="saveEditedMember('${member.id}')" style="flex:1;">üíæ Save</button>
                        <button class="btn" onclick="resetPin('${member.id}')" style="flex:1;background:#ff9800;">üîê Reset PIN</button>
                        <button class="btn" onclick="showAllMembers()" style="flex:1;background:#666;">‚Ü©Ô∏è Cancel</button>
                    </div>
                </div>
            `;
        }

        async function saveEditedMember(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            const name = document.getElementById('editName').value.trim();
            const phone = document.getElementById('editPhone').value.trim();
            const pin = document.getElementById('editPin').value.trim();
            const savings = parseFloat(document.getElementById('editSavings').value) || 0;
            const loan = parseFloat(document.getElementById('editLoan').value) || 0;
            const membershipPaid = document.getElementById('editMembership').checked;
            const socialPaid = document.getElementById('editSocial').checked;
            
            if (!name) {
                alert('Enter a name');
                return;
            }
            
            const changes = {
                name,
                phone,
                pin,
                savings,
                loanPrincipal: loan,
                membershipPaid,
                socialPaid
            };
            
            Object.assign(member, changes);
            localStorage.setItem('members', JSON.stringify(members));
            
            if (!navigator.onLine) {
                enqueueEdit({ type: 'edit-member', memberId, changes, ts: Date.now() });
                notificationCenter.add('Saved locally; will sync when online', 'info');
            } else {
                await saveMembers();
                notificationCenter.add('Member updated successfully', 'success');
            }
            
            showAllMembers();
        }

        async function resetPin(memberId) {
            if (!currentUser || currentUser.type !== 'admin') {
                alert('Only admins can reset PINs');
                return;
            }
            
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            if (!confirm(`Reset PIN for ${member.name} to last 4 digits of phone?`)) return;
            
            member.pin = (member.phone || '').slice(-4);
            localStorage.setItem('members', JSON.stringify(members));
            
            if (!navigator.onLine) {
                enqueueEdit({ type: 'edit-member', memberId, changes: { pin: member.pin }, ts: Date.now() });
                notificationCenter.add('PIN reset locally; will sync when online', 'info');
            } else {
                await saveMembers();
                notificationCenter.add('PIN reset successfully', 'success');
            }
            
            showAllMembers();
        }

        // ============================================
        // MEMBER DASHBOARD - WITH TRANSACTION HISTORY (VIEW-ONLY)
        // ============================================
        function showMemberDashboard(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            const loanInterestDue = (member.loanPrincipal || 0) * RULES.INTEREST;
            const totalSavingsIncl = members.reduce((sum, m) => sum + ((m.savings || 0) * (1 + RULES.INTEREST)), 0);
            const totalLoansIncl = members.reduce((sum, m) => sum + ((m.loanPrincipal || 0) * (1 + RULES.INTEREST)), 0);
            const netValue = totalSavingsIncl - totalLoansIncl;
            const sharePool = netValue * 0.10;
            const memberSavingsIncl = (member.savings || 0) * (1 + RULES.INTEREST);
            const memberLoanIncl = (member.loanPrincipal || 0) * (1 + RULES.INTEREST);
            const memberNet = memberSavingsIncl - memberLoanIncl;
            const memberTakeHome = netValue !== 0 ? (sharePool * (memberNet / netValue)) : 0;
            
            const transactions = (member.transactions || [])
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const monthlySummaries = {};
            transactions.forEach(t => {
                const date = new Date(t.date);
                const monthYear = date.toLocaleDateString(undefined, { year: 'numeric', month: 'long' });
                if (!monthlySummaries[monthYear]) {
                    monthlySummaries[monthYear] = { savings: 0, loans: 0, repayments: 0, fees: 0 };
                }
                if (t.type === 'savings') monthlySummaries[monthYear].savings += (t.amount || 0);
                if (t.type === 'loan') monthlySummaries[monthYear].loans += (t.amount || 0);
                if (t.type === 'repayment') monthlySummaries[monthYear].repayments += (t.amount || 0);
                if (t.type === 'fee') monthlySummaries[monthYear].fees += (t.amount || 0);
            });
            
            const colors = ['#1e88e5', '#e91e63', '#9c27b0', '#ff9800', '#4caf50', '#f44336'];
            const avatarColor = colors[member.name.length % colors.length];
            const initials = member.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
            
            document.getElementById('app').innerHTML = `
                <div class="header">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div style="display:flex;align-items:center;gap:20px;">
                            <div class="avatar-large" style="background:${avatarColor};">${initials}</div>
                            <div>
                                <h1 style="margin:0;">üí∞ SAVERS GROUP</h1>
                                <p style="opacity:0.9;margin-top:5px;">Welcome back, ${member.name} üëã</p>
                            </div>
                        </div>
                        <div style="display:flex;gap:15px;align-items:center;">
                            <div id="networkStatus" style="background:rgba(255,255,255,0.15);padding:8px 16px;border-radius:8px;font-weight:bold;color:#fff;">
                                ${navigator.onLine ? 'Online' : 'Offline'}
                            </div>
                            
                            <div id="themeToggle" class="theme-toggle" onclick="ThemeManager.toggle()">
                                <i class="fas ${document.documentElement.getAttribute('data-theme') === 'light' ? 'fa-moon' : 'fa-sun'}"></i>
                                <span>${document.documentElement.getAttribute('data-theme') === 'light' ? 'Dark' : 'Light'}</span>
                            </div>
                            
                            <button class="btn" onclick="showEditProfile('${member.id}')" style="background:#ff9800;">
                                <i class="fas fa-key"></i> Change PIN
                            </button>
                            
                            <button class="btn" onclick="logout()" style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="content">
                    <!-- Account Summary Cards -->
                    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:30px;">
                        <div style="background:var(--card-bg);padding:20px;border-radius:16px;border:1px solid var(--border-color);box-shadow:var(--shadow);">
                            <div style="display:flex;align-items:center;gap:15px;">
                                <div style="width:50px;height:50px;border-radius:12px;background:rgba(30,136,229,0.1);display:flex;align-items:center;justify-content:center;">
                                    <i class="fas fa-piggy-bank" style="font-size:24px;color:#1e88e5;"></i>
                                </div>
                                <div>
                                    <div style="color:var(--text-secondary);font-size:0.85em;text-transform:uppercase;letter-spacing:0.5px;">Savings Balance</div>
                                    <div style="font-size:1.8em;font-weight:700;color:#1e88e5;">K${(member.savings || 0).toLocaleString()}</div>
                                    <div style="color:var(--text-secondary);font-size:0.85em;margin-top:5px;">
                                        <i class="fas fa-chart-line"></i> +10% interest: K${((member.savings || 0) * RULES.INTEREST).toFixed(2)}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background:var(--card-bg);padding:20px;border-radius:16px;border:1px solid var(--border-color);box-shadow:var(--shadow);">
                            <div style="display:flex;align-items:center;gap:15px;">
                                <div style="width:50px;height:50px;border-radius:12px;background:rgba(244,67,54,0.1);display:flex;align-items:center;justify-content:center;">
                                    <i class="fas fa-hand-holding-usd" style="font-size:24px;color:#f44336;"></i>
                                </div>
                                <div>
                                    <div style="color:var(--text-secondary);font-size:0.85em;text-transform:uppercase;letter-spacing:0.5px;">Loan Balance</div>
                                    <div style="font-size:1.8em;font-weight:700;color:#f44336;">K${((member.loanPrincipal || 0) * (1 + RULES.INTEREST)).toLocaleString()}</div>
                                    <div style="color:var(--text-secondary);font-size:0.85em;margin-top:5px;">
                                        <i class="fas fa-exclamation-circle"></i> Interest due: K${loanInterestDue.toFixed(2)}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background:var(--card-bg);padding:20px;border-radius:16px;border:1px solid var(--border-color);box-shadow:var(--shadow);">
                            <div style="display:flex;align-items:center;gap:15px;">
                                <div style="width:50px;height:50px;border-radius:12px;background:rgba(46,125,50,0.1);display:flex;align-items:center;justify-content:center;">
                                    <i class="fas fa-calculator" style="font-size:24px;color:#2e7d32;"></i>
                                </div>
                                <div>
                                    <div style="color:var(--text-secondary);font-size:0.85em;text-transform:uppercase;letter-spacing:0.5px;">Net Position</div>
                                    <div style="font-size:1.8em;font-weight:700;color:#2e7d32;">K${memberNet.toLocaleString()}</div>
                                    <div style="color:var(--text-secondary);font-size:0.85em;margin-top:5px;">
                                        <i class="fas fa-balance-scale"></i> Savings - Loan
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background:var(--card-bg);padding:20px;border-radius:16px;border:1px solid var(--border-color);box-shadow:var(--shadow);">
                            <div style="display:flex;align-items:center;gap:15px;">
                                <div style="width:50px;height:50px;border-radius:12px;background:rgba(255,152,0,0.1);display:flex;align-items:center;justify-content:center;">
                                    <i class="fas fa-gift" style="font-size:24px;color:#ff9800;"></i>
                                </div>
                                <div>
                                    <div style="color:var(--text-secondary);font-size:0.85em;text-transform:uppercase;letter-spacing:0.5px;">Share Out (10%)</div>
                                    <div style="font-size:1.8em;font-weight:700;color:#ff9800;">K${memberTakeHome.toFixed(2)}</div>
                                    <div style="color:var(--text-secondary);font-size:0.85em;margin-top:5px;">
                                        <i class="fas fa-percent"></i> Your share of profits
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status Cards -->
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:30px;">
                        <div style="background:${member.membershipPaid ? '#e8f5e9' : '#ffebee'};padding:15px;border-radius:12px;border:1px solid ${member.membershipPaid ? '#c8e6c9' : '#ffcdd2'};">
                            <div style="display:flex;align-items:center;gap:10px;">
                                <i class="fas fa-id-card" style="font-size:20px;color:${member.membershipPaid ? '#2e7d32' : '#f44336'};"></i>
                                <div>
                                    <strong>Membership Fee</strong>
                                    <div style="color:${member.membershipPaid ? '#2e7d32' : '#f44336'};font-size:14px;">
                                        ${member.membershipPaid ? '‚úÖ Paid (K50)' : '‚ùå Not Paid'}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background:${member.socialPaid ? '#e8f5e9' : '#ffebee'};padding:15px;border-radius:12px;border:1px solid ${member.socialPaid ? '#c8e6c9' : '#ffcdd2'};">
                            <div style="display:flex;align-items:center;gap:10px;">
                                <i class="fas fa-users" style="font-size:20px;color:${member.socialPaid ? '#2e7d32' : '#f44336'};"></i>
                                <div>
                                    <strong>Social Fund</strong>
                                    <div style="color:${member.socialPaid ? '#2e7d32' : '#f44336'};font-size:14px;">
                                        ${member.socialPaid ? '‚úÖ Paid (K100)' : '‚ùå Not Paid'}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background:${member.loanPrincipal > 0 ? '#fff3e0' : '#e8f5e9'};padding:15px;border-radius:12px;border:1px solid ${member.loanPrincipal > 0 ? '#ffe0b2' : '#c8e6c9'};">
                            <div style="display:flex;align-items:center;gap:10px;">
                                <i class="fas fa-chart-bar" style="font-size:20px;color:${member.loanPrincipal > 0 ? '#ff9800' : '#2e7d32'};"></i>
                                <div>
                                    <strong>Loan Status</strong>
                                    <div style="color:${member.loanPrincipal > 0 ? '#ff9800' : '#2e7d32'};font-size:14px;">
                                        ${member.loanPrincipal > 0 ? 'üè¶ Active Loan' : '‚úÖ No Loan'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Transaction History Section (VIEW-ONLY) -->
                    <div style="background:var(--card-bg);border-radius:20px;border:1px solid var(--border-color);overflow:hidden;margin-bottom:30px;">
                        <div style="padding:20px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <h3 style="margin:0;display:flex;align-items:center;gap:10px;">
                                    <i class="fas fa-history" style="color:var(--primary);"></i>
                                    Transaction History
                                </h3>
                                <p style="color:var(--text-secondary);margin:5px 0 0;font-size:14px;">
                                    <i class="fas fa-info-circle"></i> View-only - Contact admin for any corrections
                                </p>
                            </div>
                            <div style="display:flex;gap:10px;">
                                <select id="transactionFilter" onchange="filterMemberTransactions('${member.id}')" style="padding:10px;border-radius:8px;border:1px solid var(--border-color);background:var(--card-bg);color:var(--text-primary);">
                                    <option value="all">All Transactions</option>
                                    <option value="savings">Savings Only</option>
                                    <option value="loan">Loans Only</option>
                                    <option value="repayment">Repayments Only</option>
                                    <option value="fee">Fees Only</option>
                                </select>
                                <select id="dateRangeFilter" onchange="filterMemberTransactions('${member.id}')" style="padding:10px;border-radius:8px;border:1px solid var(--border-color);background:var(--card-bg);color:var(--text-primary);">
                                    <option value="all">All Time</option>
                                    <option value="30">Last 30 Days</option>
                                    <option value="90">Last 3 Months</option>
                                    <option value="365">Last Year</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="memberTransactionList" style="padding:20px;max-height:500px;overflow-y:auto;">
                            ${generateMemberTransactionHTML(member, transactions)}
                        </div>
                        
                        ${Object.keys(monthlySummaries).length > 0 ? `
                            <div style="padding:20px;border-top:1px solid var(--border-color);background:var(--gray-100);">
                                <h4 style="margin-bottom:15px;"><i class="fas fa-calendar-alt"></i> Monthly Summary</h4>
                                <div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(250px,1fr));gap:15px;">
                                    ${Object.keys(monthlySummaries).slice(0, 6).map(month => `
                                        <div style="background:var(--card-bg);padding:15px;border-radius:12px;border:1px solid var(--border-color);">
                                            <div style="font-weight:600;margin-bottom:10px;color:var(--primary);">${month}</div>
                                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px;">
                                                ${monthlySummaries[month].savings > 0 ? `
                                                    <span style="color:var(--text-secondary);">Savings:</span>
                                                    <span style="color:#2e7d32;font-weight:600;">+K${monthlySummaries[month].savings.toFixed(2)}</span>
                                                ` : ''}
                                                ${monthlySummaries[month].loans > 0 ? `
                                                    <span style="color:var(--text-secondary);">Loans:</span>
                                                    <span style="color:#f44336;font-weight:600;">K${monthlySummaries[month].loans.toFixed(2)}</span>
                                                ` : ''}
                                                ${monthlySummaries[month].repayments > 0 ? `
                                                    <span style="color:var(--text-secondary);">Repayments:</span>
                                                    <span style="color:#ff9800;font-weight:600;">-K${monthlySummaries[month].repayments.toFixed(2)}</span>
                                                ` : ''}
                                                ${monthlySummaries[month].fees > 0 ? `
                                                    <span style="color:var(--text-secondary);">Fees:</span>
                                                    <span style="color:#9c27b0;font-weight:600;">K${monthlySummaries[month].fees.toFixed(2)}</span>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Account Summary & Download -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px;">
                        <div style="background:var(--card-bg);padding:20px;border-radius:16px;border:1px solid var(--border-color);">
                            <h4 style="margin-top:0;margin-bottom:15px;display:flex;align-items:center;gap:10px;">
                                <i class="fas fa-file-invoice"></i> Account Summary
                            </h4>
                            <table style="width:100%;border-collapse:collapse;">
                                <tr>
                                    <td style="padding:10px 0;color:var(--text-secondary);">Member Since:</td>
                                    <td style="padding:10px 0;font-weight:600;">${member.transactions && member.transactions.length ? fmtDate(member.transactions[member.transactions.length-1].date) : 'N/A'}</td>
                                </tr>
                                <tr>
                                    <td style="padding:10px 0;color:var(--text-secondary);">Total Savings:</td>
                                    <td style="padding:10px 0;font-weight:600;color:#1e88e5;">K${(member.savings || 0).toLocaleString()}</td>
                                </tr>
                                <tr>
                                    <td style="padding:10px 0;color:var(--text-secondary);">Total Interest Earned:</td>
                                    <td style="padding:10px 0;font-weight:600;color:#2e7d32;">
                                        K${transactions.filter(t => t.interest).reduce((sum, t) => sum + (t.interest || 0), 0).toFixed(2)}
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding:10px 0;color:var(--text-secondary);">Total Loans Taken:</td>
                                    <td style="padding:10px 0;font-weight:600;color:#f44336;">
                                        K${transactions.filter(t => t.type === 'loan').reduce((sum, t) => sum + (t.amount || 0), 0).toLocaleString()}
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding:10px 0;color:var(--text-secondary);">Total Repayments:</td>
                                    <td style="padding:10px 0;font-weight:600;color:#ff9800;">
                                        K${transactions.filter(t => t.type === 'repayment').reduce((sum, t) => sum + (t.amount || 0), 0).toLocaleString()}
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding:10px 0;color:var(--text-secondary);">Total Fees Paid:</td>
                                    <td style="padding:10px 0;font-weight:600;color:#9c27b0;">
                                        K${transactions.filter(t => t.type === 'fee').reduce((sum, t) => sum + (t.amount || 0), 0).toLocaleString()}
                                    </td>
                                </tr>
                            </table>
                        </div>
                        
                        <div style="background:var(--card-bg);padding:20px;border-radius:16px;border:1px solid var(--border-color);">
                            <h4 style="margin-top:0;margin-bottom:15px;display:flex;align-items:center;gap:10px;">
                                <i class="fas fa-download"></i> Download Statements
                            </h4>
                            <p style="color:var(--text-secondary);margin-bottom:20px;font-size:14px;">
                                Download your transaction history for your records.
                            </p>
                            <div style="display:flex;flex-direction:column;gap:10px;">
                                <button class="btn" onclick="downloadMemberStatement('${member.id}', 'csv')" style="background:#2e7d32;display:flex;align-items:center;justify-content:center;gap:10px;">
                                    <i class="fas fa-file-csv"></i> Download as CSV
                                </button>
                                <button class="btn" onclick="downloadMemberStatement('${member.id}', 'pdf')" style="background:#f44336;display:flex;align-items:center;justify-content:center;gap:10px;">
                                    <i class="fas fa-file-pdf"></i> Download as PDF
                                </button>
                                <button class="btn" onclick="printMemberStatement('${member.id}')" style="background:#607d8b;display:flex;align-items:center;justify-content:center;gap:10px;">
                                    <i class="fas fa-print"></i> Print Statement
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- View-Only Notice -->
                    <div style="padding:20px;background:rgba(30,136,229,0.05);border-radius:12px;border:1px dashed var(--primary);text-align:center;">
                        <i class="fas fa-shield-alt" style="font-size:24px;color:var(--primary);margin-bottom:10px;display:block;"></i>
                        <h4 style="margin:0 0 10px;color:var(--text-primary);">View-Only Transaction History</h4>
                        <p style="color:var(--text-secondary);margin:0;font-size:14px;">
                            This is your personal transaction record. For any corrections or disputes, 
                            please contact the group administrator. You cannot edit or delete transactions.
                        </p>
                    </div>
                </div>
            `;
            
            updateNetworkStatus();
            ThemeManager.updateIcon();
        }

        // ===== HELPER: Generate Transaction HTML (VIEW-ONLY) =====
        function generateMemberTransactionHTML(member, transactions, filter = 'all', dateRange = 'all') {
            let filteredTxs = [...transactions];
            
            if (filter !== 'all') {
                filteredTxs = filteredTxs.filter(t => t.type === filter);
            }
            
            if (dateRange !== 'all') {
                const daysAgo = parseInt(dateRange);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - daysAgo);
                filteredTxs = filteredTxs.filter(t => new Date(t.date) >= cutoffDate);
            }
            
            if (filteredTxs.length === 0) {
                return `
                    <div style="text-align:center;padding:60px 20px;color:var(--text-secondary);">
                        <i class="fas fa-inbox" style="font-size:48px;margin-bottom:15px;opacity:0.5;"></i>
                        <h4>No Transactions Found</h4>
                        <p style="margin-top:10px;">There are no transactions matching your criteria.</p>
                    </div>
                `;
            }
            
            let html = '<div style="position:relative;">';
            
            filteredTxs.forEach(t => {
                let icon, color, bgColor, amountPrefix;
                
                switch(t.type) {
                    case 'savings':
                        icon = 'fa-piggy-bank';
                        color = '#2e7d32';
                        bgColor = 'rgba(46,125,50,0.1)';
                        amountPrefix = '+';
                        break;
                    case 'loan':
                        icon = 'fa-hand-holding-usd';
                        color = '#f44336';
                        bgColor = 'rgba(244,67,54,0.1)';
                        amountPrefix = '';
                        break;
                    case 'repayment':
                        icon = 'fa-undo';
                        color = '#ff9800';
                        bgColor = 'rgba(255,152,0,0.1)';
                        amountPrefix = '-';
                        break;
                    case 'fee':
                        icon = 'fa-check-circle';
                        color = '#9c27b0';
                        bgColor = 'rgba(156,39,176,0.1)';
                        amountPrefix = '';
                        break;
                    default:
                        icon = 'fa-circle';
                        color = '#607d8b';
                        bgColor = 'rgba(96,125,139,0.1)';
                        amountPrefix = '';
                }
                
                const date = new Date(t.date);
                const formattedDate = date.toLocaleDateString(undefined, { 
                    weekday: 'short',
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                const formattedTime = date.toLocaleTimeString(undefined, { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                html += `
                    <div style="display:flex;gap:15px;margin-bottom:15px;padding:15px;background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;">
                        <div style="width:40px;height:40px;border-radius:50%;background:${bgColor};display:flex;align-items:center;justify-content:center;">
                            <i class="fas ${icon}" style="color:${color};font-size:18px;"></i>
                        </div>
                        
                        <div style="flex:1;">
                            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                                <div>
                                    <span style="display:inline-block;padding:4px 12px;border-radius:20px;background:${bgColor};color:${color};font-size:12px;font-weight:600;text-transform:uppercase;margin-bottom:8px;">
                                        ${t.type.toUpperCase()}
                                    </span>
                                    <div style="font-weight:600;margin-bottom:4px;">
                                        ${t.note || (t.type === 'savings' ? 'Savings Deposit' : 
                                                   t.type === 'loan' ? 'Loan Contract' : 
                                                   t.type === 'repayment' ? 'Loan Repayment' : 
                                                   t.type === 'fee' ? 'Fee Payment' : 'Transaction')}
                                    </div>
                                    <div style="display:flex;gap:15px;color:var(--text-secondary);font-size:13px;">
                                        <span><i class="fas fa-calendar"></i> ${formattedDate}</span>
                                        <span><i class="fas fa-clock"></i> ${formattedTime}</span>
                                    </div>
                                </div>
                                <div style="text-align:right;">
                                    <div style="font-size:20px;font-weight:700;color:${color};">
                                        ${amountPrefix}K${(t.amount || 0).toLocaleString()}
                                    </div>
                                    ${t.interest ? `
                                        <div style="font-size:13px;color:${color};margin-top:5px;">
                                            + K${t.interest.toFixed(2)} interest
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            ${t.note && !['Savings Deposit', 'Loan Contract', 'Loan Repayment', 'Fee Payment'].includes(t.note) ? `
                                <div style="margin-top:10px;padding-top:10px;border-top:1px dashed var(--border-color);color:var(--text-secondary);font-size:13px;">
                                    <i class="fas fa-comment"></i> ${t.note}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        // ===== FILTER MEMBER TRANSACTIONS (VIEW-ONLY) =====
        function filterMemberTransactions(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            const filter = document.getElementById('transactionFilter').value;
            const dateRange = document.getElementById('dateRangeFilter').value;
            
            const transactions = (member.transactions || [])
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            document.getElementById('memberTransactionList').innerHTML = 
                generateMemberTransactionHTML(member, transactions, filter, dateRange);
        }

        // ===== DOWNLOAD MEMBER STATEMENT =====
        function downloadMemberStatement(memberId, format = 'csv') {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            const transactions = (member.transactions || [])
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (format === 'csv') {
                let csv = 'Date,Time,Type,Amount,Interest,Note\n';
                
                transactions.forEach(t => {
                    const date = new Date(t.date);
                    const formattedDate = date.toLocaleDateString();
                    const formattedTime = date.toLocaleTimeString();
                    const amount = t.amount || 0;
                    const interest = t.interest || 0;
                    const note = (t.note || '').replace(/,/g, ';');
                    
                    csv += `${formattedDate},${formattedTime},${t.type},${amount},${interest},"${note}"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${member.name.replace(/\s+/g, '_')}_statement_${new Date().toISOString().slice(0,10)}.csv`;
                a.click();
                URL.revokeObjectURL(url);
                
                notificationCenter.add('Statement downloaded successfully!', 'success');
            } else if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(20);
                doc.text('Transaction Statement', 20, 20);
                
                doc.setFontSize(14);
                doc.text(`Member: ${member.name}`, 20, 35);
                doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 45);
                
                doc.setFontSize(12);
                let y = 60;
                
                transactions.slice(0, 20).forEach((t, i) => {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    const date = new Date(t.date).toLocaleDateString();
                    const amount = t.amount || 0;
                    doc.text(`${i+1}. ${date} - ${t.type.toUpperCase()} - K${amount} ${t.note ? `- ${t.note}` : ''}`, 20, y);
                    y += 8;
                });
                
                doc.save(`${member.name.replace(/\s+/g, '_')}_statement_${new Date().toISOString().slice(0,10)}.pdf`);
                notificationCenter.add('PDF statement generated!', 'success');
            }
        }

        // ===== PRINT MEMBER STATEMENT =====
        function printMemberStatement(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            const transactions = (member.transactions || [])
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Transaction Statement - ${member.name}</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 40px; }
                            h1 { color: #1e88e5; }
                            .header { margin-bottom: 30px; }
                            .transaction { 
                                border-bottom: 1px solid #eee; 
                                padding: 10px 0;
                                display: flex;
                                justify-content: space-between;
                            }
                            .date { color: #666; font-size: 14px; }
                            .amount { font-weight: bold; }
                            .savings { color: #2e7d32; }
                            .loan { color: #f44336; }
                            .repayment { color: #ff9800; }
                            .fee { color: #9c27b0; }
                            .summary { margin-top: 30px; padding: 20px; background: #f5f5f5; border-radius: 8px; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>Savers Group - Transaction Statement</h1>
                            <h2>${member.name}</h2>
                            <p>Generated: ${new Date().toLocaleString()}</p>
                            <p>Current Savings Balance: K${(member.savings || 0).toLocaleString()}</p>
                            <p>Current Loan Balance: K${((member.loanPrincipal || 0) * (1 + RULES.INTEREST)).toLocaleString()}</p>
                        </div>
                        
                        <h3>Transaction History</h3>
                        ${transactions.map(t => {
                            const date = new Date(t.date).toLocaleString();
                            const amount = t.amount || 0;
                            const typeClass = t.type === 'savings' ? 'savings' : 
                                             t.type === 'loan' ? 'loan' : 
                                             t.type === 'repayment' ? 'repayment' : 'fee';
                            return `
                                <div class="transaction">
                                    <div>
                                        <div><strong>${t.type.toUpperCase()}</strong></div>
                                        <div class="date">${date}</div>
                                        <div style="color:#666;font-size:12px;">${t.note || ''}</div>
                                    </div>
                                    <div class="amount ${typeClass}">
                                        ${t.type === 'repayment' ? '-' : ''}K${amount.toLocaleString()}
                                        ${t.interest ? `<br><small>+K${t.interest.toFixed(2)} interest</small>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        
                        <div class="summary">
                            <h3>Summary</h3>
                            <p>Total Savings: K${(member.savings || 0).toLocaleString()}</p>
                            <p>Total Loans: K${((member.loanPrincipal || 0) * (1 + RULES.INTEREST)).toLocaleString()}</p>
                            <p>Total Interest Earned: K${transactions.filter(t => t.interest).reduce((sum, t) => sum + (t.interest || 0), 0).toFixed(2)}</p>
                            <p>Total Transactions: ${transactions.length}</p>
                        </div>
                        
                        <div style="margin-top:40px;text-align:center;color:#666;font-size:12px;">
                            This is an official statement from Savers Group. For any queries, contact the administrator.
                        </div>
                    </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
            
            notificationCenter.add('Print window opened', 'info');
        }

        // ===== EDIT PROFILE (MEMBER CHANGE PIN) =====
        function showEditProfile(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            document.getElementById('app').innerHTML = `
                <div class="header">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <h1>üí∞ SAVERS GROUP</h1>
                            <p style="opacity:0.9;margin-top:5px;">Change PIN</p>
                        </div>
                        <div style="display:flex;gap:10px;align-items:center;">
                            <div id="networkStatus" style="background:rgba(255,255,255,0.15);padding:8px 16px;border-radius:8px;font-weight:bold;color:#fff;">
                                ${navigator.onLine ? 'Online' : 'Offline'}
                            </div>
                            <button class="btn" onclick="showMemberDashboard('${member.id}')" style="background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);">
                                <i class="fas fa-arrow-left"></i> Back
                            </button>
                        </div>
                    </div>
                </div>
                <div class="content">
                    <div class="member-card" style="max-width:500px;margin:0 auto;">
                        <div style="text-align:center;margin-bottom:30px;">
                            <div class="avatar-large" style="background:${['#1e88e5', '#e91e63', '#9c27b0', '#ff9800', '#4caf50', '#f44336'][member.name.length % 6]};margin:0 auto;">
                                ${member.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2)}
                            </div>
                            <h3 style="margin:15px 0 5px;">${member.name}</h3>
                            <p style="color:var(--text-secondary);">Change your login PIN</p>
                        </div>
                        
                        <p style="color:var(--text-secondary);margin-bottom:20px;font-size:14px;text-align:center;">
                            Your current PIN is the last 4 digits of your phone (${member.phone ? member.phone.slice(-4) : '----'}) unless you set a custom PIN.
                        </p>
                        
                        <div style="width:100%; margin-bottom:20px;">
                            <input type="password" id="editPin" placeholder="New 4-digit PIN" maxlength="8">
                        </div>
                        
                        <div style="display:flex;gap:10px;margin-top:20px;">
                            <button class="btn" onclick="saveProfilePin('${member.id}')" style="flex:1;background:#ff9800;">üíæ Save New PIN</button>
                            <button class="btn" onclick="showMemberDashboard('${member.id}')" style="flex:1;background:#666;">‚Ü©Ô∏è Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            updateNetworkStatus();
        }

        async function saveProfilePin(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            const pin = document.getElementById('editPin').value.trim();
            if (!pin || pin.length < 4) {
                alert('Enter a PIN of at least 4 characters');
                return;
            }
            
            member.pin = pin;
            localStorage.setItem('members', JSON.stringify(members));
            
            if (!navigator.onLine) {
                enqueueEdit({ type: 'edit-member', memberId, changes: { pin }, ts: Date.now() });
                notificationCenter.add('PIN saved locally; will sync when online', 'info');
            } else {
                await saveMembers();
                notificationCenter.add('PIN changed successfully!', 'success');
            }
            
            showMemberDashboard(memberId);
        }

        // ===== EXPORT REPORT (PDF) =====
        async function exportReport() {
            notificationCenter.add('Generating PDF report...', 'info');
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text('Savers Group - Report', 20, 20);
            
            doc.setFontSize(12);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 30);
            doc.text(`Total Members: ${members.length}`, 20, 40);
            
            const totalSavings = members.reduce((sum, m) => sum + (m.savings || 0), 0);
            const totalLoans = members.reduce((sum, m) => sum + (m.loanPrincipal || 0), 0);
            
            doc.text(`Total Savings: K${totalSavings.toLocaleString()}`, 20, 50);
            doc.text(`Total Loans: K${totalLoans.toLocaleString()}`, 20, 60);
            
            doc.setFontSize(14);
            doc.text('Member List', 20, 80);
            
            let y = 90;
            members.forEach((member, i) => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                doc.setFontSize(10);
                doc.text(`${i + 1}. ${member.name} - Savings: K${(member.savings || 0).toLocaleString()} - Loan: K${(member.loanPrincipal || 0).toLocaleString()}`, 20, y);
                y += 8;
            });
            
            doc.save(`savers-report-${new Date().toISOString().slice(0,10)}.pdf`);
            notificationCenter.add('Report generated successfully!', 'success');
        }

        // ===== TIMELINE VIEW =====
        function showTimeline() {
            let allTransactions = [];
            members.forEach(member => {
                if (member.transactions) {
                    member.transactions.forEach(t => {
                        allTransactions.push({
                            ...t,
                            memberName: member.name,
                            memberId: member.id
                        });
                    });
           
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Savers Group</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="manifest" href="manifest.json">
    <!-- Base64 favicon -->
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjE5MiIgaGVpZ2h0PSIxOTIiIHJ4PSIyNCIgZmlsbD0iIzFFODhFNSIvPjx0ZXh0IHg9Ijk2IiB5PSI5NiIgZm9udC1zaXplPSI3MnB4IiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZpbGw9IiNGRkQ3MDAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7ihIs8L3RleHQ+PC9zdmc+" type="image/svg+xml">
    <!-- iOS PWA meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Savers Group">
    
    <style>
        /* ===== CLEAN CSS - NO CONFLICTS ===== */
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #e3f2fd;
            min-height: 100vh;
        }
        
        #app {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(90deg, #1e88e5, #64b5f6);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2em;
        }
        
        .content {
            padding: 30px;
        }
        
        /* ===== UNIFIED INPUT STYLING ===== */
        input, select, textarea, button {
            font-family: inherit;
            font-size: 16px;
        }
        
        input[type="text"],
        input[type="password"],
        input[type="tel"],
        input[type="number"],
        input[type="date"],
        select {
            width: 100%;
            padding: 14px;
            margin: 8px 0;
            border: 2px solid #90caf9;
            border-radius: 8px;
            background: white;
            display: block;
        }
        
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 0 8px 0 0;
            display: inline-block;
        }
        
        .btn {
            background: #1e88e5;
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            display: inline-block;
            transition: background 0.2s;
        }
        
        .btn:hover {
            background: #1565c0;
        }
        
        .login-box {
            background: #f8fdff;
            padding: 25px;
            border-radius: 10px;
            border: 2px solid #bbdefb;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .member-card {
            background: #f8fdff;
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border: 2px solid #bbdefb;
        }
        
        /* ===== GRID LAYOUTS ===== */
        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        /* ===== UTILITY CLASSES ===== */
        .text-center { text-align: center; }
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }
        .w-100 { width: 100%; }
        
        /* ===== MOBILE RESPONSIVE ===== */
        @media screen and (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .grid-4 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .content {
                padding: 15px;
            }
            
            .btn {
                width: 100%;
                margin: 8px 0;
            }
            
            .login-box > div:first-child .btn {
                width: auto;
            }
        }
        
        @media screen and (max-width: 480px) {
            .grid-4 {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.2em;
            }
        }
        
        /* ===== METRIC CARDS ===== */
        .metric-card {
            background: #f8fdff;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #bbdefb;
        }
        
        .metric-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #1e88e5;
        }
        
        /* ===== STATUS INDICATOR ===== */
        #networkStatus {
            background: rgba(255,255,255,0.15);
            padding: 8px;
            border-radius: 8px;
            font-weight: bold;
            color: #fff;
        }
        
        .offline #networkStatus {
            background: #f44336;
        }
        
        /* ===== FEE SECTION ===== */
        .fee-section {
            background: #fff3e0;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }
    </style>
    
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAYYE4-vtk3XXPdvwJ8-BWxiyJiKPASsnM",
            authDomain: "savers-group-app.firebaseapp.com",
            projectId: "savers-group-app",
            storageBucket: "savers-group-app.firebasestorage.app",
            messagingSenderId: "722000008713",
            appId: "1:722000008713:web:5322f5a668bfcd6ff4cad8"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        window.db = db;
    </script>
</head>
<body>
    <div id="app">
        <div class="header">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <h1>üí∞ SAVERS GROUP</h1>
                    <p>Digital Savings System</p>
                </div>
                <div id="networkStatus">Checking...</div>
            </div>
        </div>
        <div class="content">
            <div class="login-box">
                <h2>Login</h2>
                <div style="display:flex;gap:10px;margin-bottom:20px;">
                    <button class="btn" onclick="showAdminLogin()" id="adminBtn" style="flex:1;background:#1e88e5;">üëë Admin</button>
                    <button class="btn" onclick="showMemberLogin()" id="memberBtn" style="flex:1;background:#90caf9;">üë§ Member</button>
                </div>
                <div id="loginForm">
                    <input type="text" id="username" value="admin" placeholder="Admin username">
                    <input type="password" id="password" value="ChiSave" placeholder="Admin password">
                    <button class="btn" onclick="login('admin')" style="width:100%;">üîê ADMIN LOGIN</button>
                </div>
                <div class="text-center" style="margin-top:30px;color:#999;font-size:0.85rem;">
                    Created by Tha for Chibombo Savers Group
                </div>
                <button id="installButton" style="display:none; background:#2e7d32; color:white; padding:12px; border-radius:8px; margin-top:20px; width:100%;">
                    üì≤ Install App on Home Screen
                </button>
            </div>
        </div>
    </div>

    <script>
        // ===== PWA INSTALL =====
        let deferredPrompt;
        const installButton = document.getElementById('installButton');
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (installButton) installButton.style.display = 'block';
            installButton.onclick = () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then(choice => {
                    if (choice.outcome === 'accepted') console.log('User installed');
                    deferredPrompt = null;
                    installButton.style.display = 'none';
                });
            };
        });
        
        window.addEventListener('appinstalled', () => {
            if (installButton) installButton.style.display = 'none';
            deferredPrompt = null;
        });

        // ===== SERVICE WORKER =====
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registered:', reg))
                    .catch(err => console.log('Service Worker failed:', err));
            });
        }

        // ===== APP STATE =====
        let members = [];
        let currentUser = null;
        let selectedLoanMemberId = null;
        
        const RULES = {
            MIN_SAVINGS: 200,
            MEMBERSHIP_FEE: 50,
            SOCIAL_FUND: 100,
            INTEREST: 0.10
        };

        // ===== FIREBASE HELPERS =====
        async function loadMembers() {
            try {
                const docRef = db.collection('groups').doc('main');
                const docSnap = await docRef.get();
                if (docSnap.exists) {
                    members = docSnap.data().members || [];
                } else {
                    // Default members
                    members = [
                        { 
                            id: "1", 
                            name: "Stephen Mabena", 
                            phone: "0977123456", 
                            savings: 40747.52, 
                            loanPrincipal: 4600, 
                            loanInterest: 0, 
                            membershipPaid: true, 
                            socialPaid: true, 
                            pin: '3456',
                            transactions: []
                        },
                        { 
                            id: "2", 
                            name: "Peter Mwiinga", 
                            phone: "0977654321", 
                            savings: 27500, 
                            loanPrincipal: 16500, 
                            loanInterest: 0, 
                            membershipPaid: true, 
                            socialPaid: true, 
                            pin: '4321',
                            transactions: []
                        }
                    ];
                }
                localStorage.setItem('members', JSON.stringify(members));
            } catch (e) {
                console.error('Error loading members:', e);
                const local = localStorage.getItem('members');
                members = local ? JSON.parse(local) : [];
            }
            setTimeout(processQueue, 1000);
        }

        async function saveMembers() {
            localStorage.setItem('members', JSON.stringify(members));
            if (!navigator.onLine) return false;
            try {
                await db.collection('groups').doc('main').set({ members });
                return true;
            } catch (e) {
                console.error('Error saving members:', e);
                return false;
            }
        }

        // ===== UI HELPERS =====
        function fmtDate(iso) {
            try {
                return new Date(iso).toLocaleDateString(undefined, { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
            } catch (e) { 
                return iso; 
            }
        }

        function showToast(msg, timeout = 3000) {
            const t = document.createElement('div');
            t.textContent = msg;
            t.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 18px;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:9999;';
            document.body.appendChild(t);
            setTimeout(() => t.remove(), timeout);
        }

        // ===== OFFLINE QUEUE =====
        function enqueueEdit(edit) {
            const key = 'pendingEdits';
            const q = JSON.parse(localStorage.getItem(key) || '[]');
            q.push(edit);
            localStorage.setItem(key, JSON.stringify(q));
            updateNetworkStatus();
        }

        async function processQueue() {
            if (!navigator.onLine) return;
            const key = 'pendingEdits';
            const q = JSON.parse(localStorage.getItem(key) || '[]');
            if (q.length === 0) return;
            
            q.forEach(item => {
                if (item.type === 'edit-member') {
                    const m = members.find(x => x.id === item.memberId);
                    if (m) Object.assign(m, item.changes);
                } else if (item.type === 'add-member') {
                    members.push(item.member);
                }
            });
            
            const saved = await saveMembers();
            if (saved) {
                localStorage.removeItem(key);
                showToast('Pending changes synced');
                updateAdminMetrics();
            }
        }

        function updateNetworkStatus() {
            const el = document.getElementById('networkStatus');
            if (!el) return;
            
            if (navigator.onLine) {
                el.textContent = 'Online';
                el.style.background = 'rgba(255,255,255,0.15)';
                document.body.classList.remove('offline');
            } else {
                const q = JSON.parse(localStorage.getItem('pendingEdits') || '[]');
                el.textContent = q.length ? `Offline ‚Ä¢ ${q.length} pending` : 'Offline';
                el.style.background = '#f44336';
                document.body.classList.add('offline');
            }
        }

        window.addEventListener('online', () => { 
            updateNetworkStatus(); 
            processQueue(); 
        });
        window.addEventListener('offline', updateNetworkStatus);

        // ===== LOGIN FUNCTIONS =====
        function showAdminLogin() {
            document.getElementById('loginForm').innerHTML = `
                <input type="text" id="username" value="admin" placeholder="Admin username">
                <input type="password" id="password" value="ChiSave" placeholder="Admin password">
                <button class="btn" onclick="login('admin')" style="width:100%;">üîê ADMIN LOGIN</button>
            `;
            document.getElementById('adminBtn').style.background = '#1e88e5';
            document.getElementById('memberBtn').style.background = '#90caf9';
        }

        function showMemberLogin() {
            document.getElementById('loginForm').innerHTML = `
                <select id="memberSelect">
                    <option value="">-- Select Your Name --</option>
                    ${members.map(m => `<option value="${m.id}">${m.name}</option>`).join('')}
                </select>
                <input type="password" id="memberPass" placeholder="PIN (last 4 digits of phone)">
                <button class="btn" onclick="login('member')" style="width:100%;background:#26a69a;">üë§ MEMBER LOGIN</button>
            `;
            document.getElementById('memberBtn').style.background = '#1e88e5';
            document.getElementById('adminBtn').style.background = '#90caf9';
        }

        function login(type) {
            if (type === 'admin') {
                const user = document.getElementById('username').value;
                const pass = document.getElementById('password').value;
                if (user === 'admin' && pass === 'ChiSave') {
                    currentUser = { type: 'admin', name: 'Admin' };
                    showAdminDashboard();
                } else {
                    alert('Wrong username or password');
                }
            } else {
                const memberId = document.getElementById('memberSelect').value;
                const pass = document.getElementById('memberPass').value;
                if (!memberId) {
                    alert('Select your name');
                    return;
                }
                const member = members.find(m => m.id === memberId);
                const expectedPin = member.pin || (member.phone || '').slice(-4);
                if (member && pass === expectedPin) {
                    currentUser = { type: 'member', name: member.name, id: member.id };
                    showMemberDashboard(member.id);
                } else {
                    alert('Wrong PIN');
                }
            }
        }

        function logout() {
            currentUser = null;
            showLoginScreen();
        }

        function showLoginScreen() {
            document.getElementById('app').innerHTML = `
                <div class="header">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <h1>üí∞ SAVERS GROUP</h1>
                            <p>Digital Savings System</p>
                        </div>
                        <div id="networkStatus">Checking...</div>
                    </div>
                </div>
                <div class="content">
                    <div class="login-box">
                        <h2>Login</h2>
                        <div style="display:flex;gap:10px;margin-bottom:20px;">
                            <button class="btn" onclick="showAdminLogin()" id="adminBtn" style="flex:1;background:#1e88e5;">üëë Admin</button>
                            <button class="btn" onclick="showMemberLogin()" id="memberBtn" style="flex:1;background:#90caf9;">üë§ Member</button>
                        </div>
                        <div id="loginForm">
                            <input type="text" id="username" value="admin" placeholder="Admin username">
                            <input type="password" id="password" value="ChiSave" placeholder="Admin password">
                            <button class="btn" onclick="login('admin')" style="width:100%;">üîê ADMIN LOGIN</button>
                        </div>
                        <div class="text-center" style="margin-top:30px;color:#999;font-size:0.85rem;">
                            Created by Tha for Chibombo Savers Group
                        </div>
                    </div>
                </div>
            `;
            showAdminLogin();
            updateNetworkStatus();
        }

        // ===== ADMIN DASHBOARD =====
        function showAdminDashboard() {
            const totalSavings = members.reduce((sum, m) => sum + (m.savings || 0), 0);
            const totalLoans = members.reduce((sum, m) => sum + (m.loanPrincipal || 0), 0);
            const active = members.filter(m => m.membershipPaid && m.socialPaid).length;
            
            document.getElementById('app').innerHTML = `
                <div class="header">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <h1>üí∞ SAVERS GROUP ADMIN</h1>
                            <p>Welcome, Admin üëã</p>
                        </div>
                        <div style="display:flex;gap:10px;align-items:center;">
                            <div id="networkStatus">${navigator.onLine ? 'Online' : 'Offline'}</div>
                            <button class="btn" onclick="logout()" style="background:#666;">üö™ Logout</button>
                        </div>
                    </div>
                </div>
                <div class="content">
                    <div class="grid-4">
                        <div class="metric-card">
                            <div class="metric-label">Members</div>
                            <div id="metricMembers" class="metric-value">${members.length}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Total Savings</div>
                            <div id="metricSavings" class="metric-value">K${totalSavings.toLocaleString()}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Total Loans</div>
                            <div id="metricLoans" class="metric-value">K${totalLoans.toLocaleString()}</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Active</div>
                            <div id="metricActive" class="metric-value">${active}</div>
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <button class="btn" onclick="showAddMember()">üë§ Add Member</button>
                        <button class="btn" onclick="showAllMembers()">üìã View Members</button>
                        <button class="btn" onclick="showAddSavings()">üí∞ Add Savings</button>
                        <button class="btn" onclick="showLoanManagement()">üè¶ Manage Loans</button>
                        <button class="btn" onclick="showCollectFees()">‚úÖ Collect Fees</button>
                        <button class="btn" onclick="showShareAccount()">üìä Share Account</button>
                    </div>
                    
                    <div id="contentArea">
                        <div class="text-center" style="padding:40px;color:#666;">
                            <h2>Welcome to Admin Dashboard</h2>
                            <p>Select an action to begin</p>
                        </div>
                    </div>
                </div>
            `;
            updateNetworkStatus();
        }

        // ===== ADD MEMBER =====
        function showAddMember() {
            document.getElementById('contentArea').innerHTML = `
                <div class="member-card">
                    <h3>üë§ Add New Member</h3>
                    <input type="text" id="newName" placeholder="Full Name">
                    <input type="tel" id="newPhone" placeholder="Phone Number">
                    <input type="number" id="newSavings" value="200" min="200" step="200" placeholder="Initial Savings">
                    <small style="color:#666;display:block;">Minimum K200, multiples of 200</small>
                    
                    <div class="fee-section">
                        <h4>One-Time Fees: K150</h4>
                        <p>‚Ä¢ Membership: K50</p>
                        <p>‚Ä¢ Social Fund: K100</p>
                    </div>
                    
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button class="btn" onclick="addMember()">üíæ Save Member</button>
                        <button class="btn" onclick="showAdminDashboard()" style="background:#666;">‚Ü©Ô∏è Cancel</button>
                    </div>
                </div>
            `;
        }

        async function addMember() {
            const name = document.getElementById('newName').value.trim();
            const phone = document.getElementById('newPhone').value.trim();
            const savings = parseInt(document.getElementById('newSavings').value) || 200;
            
            if (!name) {
                alert('Enter name');
                return;
            }
            if (!phone || phone.length < 4) {
                alert('Enter a valid phone number');
                return;
            }
            if (savings < 200 || savings % 200 !== 0) {
                alert('Must be K200+ in multiples of 200');
                return;
            }
            
            const newMember = {
                id: Date.now().toString(),
                name: name,
                phone: phone,
                savings: savings,
                loanPrincipal: 0,
                loanInterest: 0,
                membershipPaid: false,
                socialPaid: false,
                pin: phone.slice(-4),
                transactions: []
            };
            
            if (savings > 0) {
                newMember.transactions.push({ 
                    type: 'savings', 
                    amount: savings, 
                    date: new Date().toISOString(), 
                    note: 'Initial savings' 
                });
            }
            
            members.push(newMember);
            localStorage.setItem('members', JSON.stringify(members));
            
            const saved = await saveMembers();
            if (!saved) {
                enqueueEdit({ type: 'add-member', member: newMember, ts: Date.now() });
                showToast('Added locally; will sync when online');
            } else {
                showToast('Member added');
            }
            
            showAdminDashboard();
        }

        // ===== VIEW ALL MEMBERS =====
        function showAllMembers() {
            let html = `<h3>üìã All Members (${members.length})</h3>`;
            
            members.forEach(member => {
                const loanTotal = (member.loanPrincipal || 0) * (1 + RULES.INTEREST);
                
                html += `
                    <div class="member-card">
                        <div style="display:flex;justify-content:space-between;align-items:start;">
                            <div>
                                <strong>${member.name}</strong>
                                <div style="color:#666;margin-top:8px;">
                                    Savings: K${(member.savings || 0).toLocaleString()} | 
                                    Loan: K${loanTotal.toLocaleString()}
                                </div>
                            </div>
                        </div>
                        <div style="display:flex;gap:10px;margin-top:15px;flex-wrap:wrap;">
                            <button class="btn" onclick="viewMember('${member.id}')" style="margin:0;">View</button>
                            <button class="btn" onclick="showEditMember('${member.id}')" style="margin:0;background:#ff9800;">‚úèÔ∏è Edit</button>
                            <button class="btn" onclick="deleteMember('${member.id}')" style="margin:0;background:#f44336;">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('contentArea').innerHTML = html;
            updateAdminMetrics();
        }

        function viewMember(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            const interest = (member.loanPrincipal || 0) * RULES.INTEREST;
            const txs = (member.transactions || []).slice().sort((a,b) => new Date(b.date) - new Date(a.date));
            
            let txHtml = '<h4 style="margin-top:20px;">Recent Transactions</h4>';
            if (txs.length === 0) {
                txHtml += '<div style="color:#666;">No transactions yet</div>';
            } else {
                txs.slice(0, 10).forEach(t => {
                    txHtml += `
                        <div style="background:white;padding:12px;border-radius:8px;margin:8px 0;border:1px solid #eee;">
                            <div style="font-weight:bold;">${fmtDate(t.date)} - K${(t.amount || 0).toLocaleString()}</div>
                            <div style="color:#666;font-size:0.9em;">${t.type}${t.note ? ' - ' + t.note : ''}</div>
                        </div>
                    `;
                });
            }

            document.getElementById('contentArea').innerHTML = `
                <div class="member-card">
                    <h3>üë§ ${member.name}</h3>
                    <div class="grid-2" style="margin:20px 0;">
                        <div style="background:white;padding:15px;border-radius:10px;">
                            <strong>Savings</strong><br>K${(member.savings || 0).toLocaleString()}
                        </div>
                        <div style="background:white;padding:15px;border-radius:10px;">
                            <strong>Loan (with interest)</strong><br>K${((member.loanPrincipal||0) * (1 + RULES.INTEREST)).toLocaleString()}
                        </div>
                        <div style="background:white;padding:15px;border-radius:10px;">
                            <strong>Interest Due</strong><br>K${interest.toFixed(2)}
                        </div>
                        <div style="background:white;padding:15px;border-radius:10px;">
                            <strong>Status</strong><br>
                            ${member.membershipPaid ? '‚úÖ' : '‚ùå'} Membership<br>
                            ${member.socialPaid ? '‚úÖ' : '‚ùå'} Social
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <button class="btn" onclick="addSavingsFor('${member.id}')">üí∞ Add Savings</button>
                        <button class="btn" onclick="addLoanFor('${member.id}')">üè¶ Add Loan</button>
                        ${!member.membershipPaid ? `<button class="btn" onclick="collectFee('${member.id}', 'membership')">‚úÖ Pay K50 Membership</button>` : ''}
                        ${!member.socialPaid ? `<button class="btn" onclick="collectFee('${member.id}', 'social')">‚úÖ Pay K100 Social</button>` : ''}
                        <button class="btn" onclick="showEditMember('${member.id}')" style="background:#ff9800;">‚úèÔ∏è Edit</button>
                        <button class="btn" onclick="showAllMembers()" style="background:#666;">‚Ü©Ô∏è Back</button>
                    </div>
                    
                    <div>${txHtml}</div>
                </div>
            `;
        }

        async function deleteMember(memberId) {
            if (confirm('Delete this member? This cannot be undone.')) {
                members = members.filter(m => m.id !== memberId);
                await saveMembers();
                showAllMembers();
            }
        }

        // ===== ADD SAVINGS =====
        function showAddSavings() {
            let html = `<h3>üí∞ Add Savings</h3>`;
            html += `<select id="savingsMember">`;
            members.forEach(m => {
                html += `<option value="${m.id}">${m.name} (K${(m.savings || 0).toLocaleString()})</option>`;
            });
            html += `</select>`;
            html += `<input type="number" id="savingsAmount" value="200" min="200" step="200" placeholder="Amount">`;
            html += `<input type="date" id="savingsDate">`;
            html += `<div style="display:flex;gap:10px;margin-top:20px;">`;
            html += `<button class="btn" onclick="processSavings()">‚úÖ Add Savings</button>`;
            html += `<button class="btn" onclick="showAdminDashboard()" style="background:#666;">‚Ü©Ô∏è Cancel</button>`;
            html += `</div>`;
            
            document.getElementById('contentArea').innerHTML = html;
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('savingsDate').value = today;
        }

        function addSavingsFor(memberId) {
            showAddSavings();
            setTimeout(() => {
                document.getElementById('savingsMember').value = memberId;
            }, 100);
        }

        async function processSavings() {
            const memberId = document.getElementById('savingsMember').value;
            const member = members.find(m => m.id === memberId);
            const amount = parseInt(document.getElementById('savingsAmount').value) || 200;
            
            if (!member) {
                alert('Select a member');
                return;
            }
            
            if (amount < 200 || amount % 200 !== 0) {
                alert('Must be K200+ in multiples of 200');
                return;
            }
            
            const interest = (member.savings || 0) * RULES.INTEREST;
            member.savings = (member.savings || 0) + amount + interest;
            
            const customDate = document.getElementById('savingsDate').value 
                ? new Date(document.getElementById('savingsDate').value).toISOString()
                : new Date().toISOString();
            
            member.transactions = member.transactions || [];
            member.transactions.push({ 
                type: 'savings', 
                amount: amount, 
                interest: interest, 
                date: customDate,
                note: 'Savings deposit' 
            });

            await saveMembers();
            alert(`‚úÖ Deposit: K${amount}\nüìà Interest added: K${interest.toFixed(2)}\nüí∞ New Total: K${member.savings.toFixed(2)}`);
            updateAdminMetrics();
            viewMember(memberId);
        }

        // ===== LOAN MANAGEMENT =====
        function showLoanManagement() {
            document.getElementById('contentArea').innerHTML = `
                <div class="member-card">
                    <h3>üè¶ Loan Management</h3>
                    <select id="loanMember">
                        ${members.map(m => {
                            const loanTotal = (m.loanPrincipal || 0) * (1 + RULES.INTEREST);
                            return `<option value="${m.id}">${m.name} (Loan: K${loanTotal.toLocaleString()})</option>`;
                        }).join('')}
                    </select>
                    <div class="grid-2" style="margin-top:20px;">
                        <button class="btn" onclick="showContractLoan()">‚ûï Contract Loan</button>
                        <button class="btn" onclick="showRepayLoan()">üí≥ Repay Loan</button>
                    </div>
                </div>
            `;
        }

        function showRepayLoan() {
            document.getElementById('contentArea').innerHTML = `
                <div class="member-card">
                    <h3>üí≥ Repay Loan</h3>
                    <select id="repayMember">
                        ${members.map(m => {
                            const loanTotal = (m.loanPrincipal || 0) * (1 + RULES.INTEREST);
                            return `<option value="${m.id}">${m.name} (Loan: K${loanTotal.toLocaleString()})</option>`;
                        }).join('')}
                    </select>
                    <input type="number" id="repayAmount" value="0" min="0" step="100" placeholder="Amount to repay">
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button class="btn" onclick="repayLoan()">‚úÖ Repay</button>
                        <button class="btn" onclick="showLoanManagement()" style="background:#666;">‚Ü©Ô∏è Cancel</button>
                    </div>
                </div>
            `;
        }

        async function repayLoan() {
            const memberId = document.getElementById('repayMember').value;
            const amount = parseFloat(document.getElementById('repayAmount').value) || 0;
            const member = members.find(m => m.id === memberId);
            
            if (!member) { alert('Select member'); return; }
            if (amount <= 0) { alert('Enter amount > 0'); return; }
            
            member.loanPrincipal = Math.max(0, (member.loanPrincipal || 0) - amount);
            member.transactions = member.transactions || [];
            member.transactions.push({ 
                type: 'repayment', 
                amount: amount, 
                date: new Date().toISOString(), 
                note: 'Loan repayment' 
            });
            
            await saveMembers();
            alert(`‚úÖ Repaid K${amount}. Remaining: K${(member.loanPrincipal||0).toLocaleString()}`);
            
            if ((member.loanPrincipal || 0) === 0) {
                member.membershipPaid = true;
                member.socialPaid = true;
                member.transactions.push({ 
                    type: 'fee-clear', 
                    amount: 0, 
                    date: new Date().toISOString(), 
                    note: 'Loan cleared ‚Äî fees auto-cleared' 
                });
                await saveMembers();
                alert(`‚úÖ ${member.name}'s loan cleared ‚Äî fees auto-cleared.`);
            }
            
            updateAdminMetrics();
            showLoanManagement();
        }

        function addLoanFor(memberId) {
            showLoanManagement();
            setTimeout(() => {
                document.getElementById('loanMember').value = memberId;
                showContractLoan();
            }, 100);
        }

        function showContractLoan() {
            const memberId = document.getElementById('loanMember').value;
            if (!memberId) {
                alert('Select a member first');
                return;
            }
            
            selectedLoanMemberId = memberId;
            const member = members.find(m => m.id === memberId);
            
            document.getElementById('contentArea').innerHTML = `
                <div class="member-card">
                    <h3>‚ûï Contract Loan for ${member.name}</h3>
                    <input type="number" id="loanAmount" value="1000" min="100" step="100" placeholder="Loan Amount">
                    <div class="fee-section">
                        <p><strong>10% Interest:</strong> K<span id="loanInterest">100</span></p>
                        <p><strong>Total Repayment:</strong> K<span id="loanTotal">1100</span></p>
                    </div>
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button class="btn" onclick="contractLoan()">‚úÖ Contract Loan</button>
                        <button class="btn" onclick="showLoanManagement()" style="background:#666;">‚Ü©Ô∏è Cancel</button>
                    </div>
                </div>
            `;
            
            document.getElementById('loanAmount').oninput = function() {
                const amount = parseFloat(this.value) || 0;
                const interest = amount * RULES.INTEREST;
                document.getElementById('loanInterest').textContent = interest.toFixed(2);
                document.getElementById('loanTotal').textContent = (amount + interest).toFixed(2);
            };
        }

        async function contractLoan() {
            const memberId = selectedLoanMemberId;
            if (!memberId) {
                alert('No member selected');
                return;
            }
            
            const member = members.find(m => m.id === memberId);
            const amount = parseInt(document.getElementById('loanAmount').value) || 0;
            
            if (amount < 100) {
                alert('Minimum loan amount is K100');
                return;
            }
            
            member.loanPrincipal = (member.loanPrincipal || 0) + amount;
            member.transactions = member.transactions || [];
            member.transactions.push({ 
                type: 'loan', 
                amount: amount, 
                date: new Date().toISOString(), 
                note: `Loan contracted (10% interest applied)` 
            });
            
            await saveMembers();
            alert(`‚úÖ Loan contracted: K${amount}\nInterest (10%): K${(amount * RULES.INTEREST).toFixed(2)}`);
            selectedLoanMemberId = null;
            updateAdminMetrics();
            showLoanManagement();
        }

        // ===== COLLECT FEES =====
        function showCollectFees() {
            document.getElementById('contentArea').innerHTML = `
                <div class="member-card">
                    <h3>‚úÖ Collect Fees</h3>
                    <div class="grid-2">
                        <button class="btn" onclick="showCollectMembership()">
                            Collect Membership (K50)
                        </button>
                        <button class="btn" onclick="showCollectSocial()">
                            Collect Social Fund (K100)
                        </button>
                    </div>
                </div>
            `;
        }

        function showCollectMembership() {
            const unpaid = members.filter(m => !m.membershipPaid);
            let html = `<h3>Collect Membership Fees (K50)</h3>`;
            
            if (unpaid.length === 0) {
                html += `<div style="padding:20px;text-align:center;">‚úÖ All members have paid!</div>`;
            } else {
                unpaid.forEach(member => {
                    html += `
                        <div class="member-card">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <strong>${member.name}</strong>
                                <button class="btn" onclick="collectFee('${member.id}', 'membership')" style="margin:0;">‚úÖ Mark Paid</button>
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('contentArea').innerHTML = html;
        }

        function showCollectSocial() {
            const unpaid = members.filter(m => !m.socialPaid);
            let html = `<h3>Collect Social Fund Fees (K100)</h3>`;
            
            if (unpaid.length === 0) {
                html += `<div style="padding:20px;text-align:center;">‚úÖ All members have paid!</div>`;
            } else {
                unpaid.forEach(member => {
                    html += `
                        <div class="member-card">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <strong>${member.name}</strong>
                                <button class="btn" onclick="collectFee('${member.id}', 'social')" style="margin:0;">‚úÖ Mark Paid</button>
                            </div>
                        </div>
                    `;
                });
            }
            
            document.getElementById('contentArea').innerHTML = html;
        }

        async function collectFee(memberId, type) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            if (type === 'membership') {
                member.membershipPaid = true;
                member.transactions = member.transactions || [];
                member.transactions.push({ 
                    type: 'fee', 
                    amount: 50, 
                    date: new Date().toISOString(), 
                    note: 'Membership fee' 
                });
                alert(`‚úÖ Membership fee collected from ${member.name}`);
            } else {
                member.socialPaid = true;
                member.transactions = member.transactions || [];
                member.transactions.push({ 
                    type: 'fee', 
                    amount: 100, 
                    date: new Date().toISOString(), 
                    note: 'Social fund' 
                });
                alert(`‚úÖ Social fund collected from ${member.name}`);
            }
            
            await saveMembers();
            updateAdminMetrics();
            
            // Return to appropriate view
            const header = document.querySelector('#contentArea h3');
            if (header && header.textContent.includes('Membership')) {
                showCollectMembership();
            } else if (header && header.textContent.includes('Social')) {
                showCollectSocial();
            } else {
                viewMember(memberId);
            }
        }

        // ===== SHARE ACCOUNT =====
        function showShareAccount() {
            const totalSavings = members.reduce((sum, m) => sum + (m.savings || 0), 0);
            const totalLoans = members.reduce((sum, m) => sum + ((m.loanPrincipal || 0) * (1 + RULES.INTEREST)), 0);
            const netValue = totalSavings - totalLoans;
            const sharePool = netValue * 0.10;
            
            let html = `
                <h3>üìä Share Account (10% Share Out)</h3>
                <div style="margin:10px 0;">
                    <button class="btn" onclick="exportShareCSV()">‚¨áÔ∏è Export CSV</button>
                </div>
                <div style="background:#e8f5e9;padding:20px;border-radius:10px;margin:20px 0;">
                    <p><strong>Total Group Savings:</strong> K${totalSavings.toLocaleString()}</p>
                    <p><strong>Total Group Loans:</strong> K${totalLoans.toLocaleString()}</p>
                    <p><strong>10% Share Pool:</strong> K${sharePool.toFixed(2)}</p>
                    <p><strong>Net Value:</strong> K${netValue.toLocaleString()}</p>
                </div>
            `;
            
            members.forEach(member => {
                const memberSavingsIncl = (member.savings || 0) * (1 + RULES.INTEREST);
                const memberLoanIncl = (member.loanPrincipal || 0) * (1 + RULES.INTEREST);
                const memberNet = memberSavingsIncl - memberLoanIncl;
                const shareFraction = netValue !== 0 ? (memberNet / netValue) : 0;
                const takeHome = sharePool * shareFraction;

                html += `
                    <div class="member-card">
                        <strong>${member.name}</strong>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;">
                            <div style="color:#666;">Savings (incl.):</div>
                            <div>K${memberSavingsIncl.toLocaleString()}</div>
                            <div style="color:#666;">Loan (incl.):</div>
                            <div>K${memberLoanIncl.toLocaleString()}</div>
                            <div style="color:#666;">Net Position:</div>
                            <div>K${memberNet.toLocaleString()}</div>
                            <div style="color:#1e88e5;font-weight:bold;">Share Payout:</div>
                            <div style="color:#1e88e5;font-weight:bold;">K${takeHome.toFixed(2)}</div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('contentArea').innerHTML = html;
            updateAdminMetrics();
        }

        function exportShareCSV() {
            const totalSavings = members.reduce((sum, m) => sum + (m.savings || 0), 0);
            const totalLoans = members.reduce((sum, m) => sum + ((m.loanPrincipal || 0) * (1 + RULES.INTEREST)), 0);
            const netValue = totalSavings - totalLoans;
            const sharePool = netValue * 0.10;
            
            let rows = [['Name', 'Savings (incl.)', 'Loan (incl.)', 'Net Position', 'Share Payout']];
            
            members.forEach(member => {
                const memberSavingsIncl = (member.savings || 0) * (1 + RULES.INTEREST);
                const memberLoanIncl = (member.loanPrincipal || 0) * (1 + RULES.INTEREST);
                const memberNet = memberSavingsIncl - memberLoanIncl;
                const shareFraction = netValue !== 0 ? (memberNet / netValue) : 0;
                const takeHome = sharePool * shareFraction;
                
                rows.push([
                    member.name,
                    memberSavingsIncl.toFixed(2),
                    memberLoanIncl.toFixed(2),
                    memberNet.toFixed(2),
                    takeHome.toFixed(2)
                ]);
            });

            const csv = rows.map(r => r.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')).join('\r\n');
            const filename = `Savers_Share_Out_${new Date().toISOString().slice(0,10)}.csv`;
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        // ===== MEMBER DASHBOARD =====
        function showMemberDashboard(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            const loanInterestDue = (member.loanPrincipal || 0) * RULES.INTEREST;
            const totalSavingsIncl = members.reduce((sum, m) => sum + ((m.savings || 0) * (1 + RULES.INTEREST)), 0);
            const totalLoansIncl = members.reduce((sum, m) => sum + ((m.loanPrincipal || 0) * (1 + RULES.INTEREST)), 0);
            const netValue = totalSavingsIncl - totalLoansIncl;
            const sharePool = netValue * 0.10;
            const memberSavingsIncl = (member.savings || 0) * (1 + RULES.INTEREST);
            const memberLoanIncl = (member.loanPrincipal || 0) * (1 + RULES.INTEREST);
            const memberNet = memberSavingsIncl - memberLoanIncl;
            const memberTakeHome = netValue !== 0 ? (sharePool * (memberNet / netValue)) : 0;
            
            document.getElementById('app').innerHTML = `
                <div class="header">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <h1>üí∞ SAVERS GROUP</h1>
                            <p>Welcome, ${member.name} üëã</p>
                        </div>
                        <div style="display:flex;gap:10px;align-items:center;">
                            <div id="networkStatus">${navigator.onLine ? 'Online' : 'Offline'}</div>
                            <button class="btn" onclick="showEditProfile('${member.id}')" style="background:#ff9800;">‚úèÔ∏è Edit PIN</button>
                            <button class="btn" onclick="logout()" style="background:#666;">üö™ Logout</button>
                        </div>
                    </div>
                </div>
                <div class="content">
                    <div class="grid-2">
                        <div style="background:#f8fdff;padding:15px;border-radius:10px;">
                            <strong>Your Savings (incl. 10%)</strong><br>
                            <span style="font-size:1.4em;font-weight:bold;color:#1e88e5;">K${(member.savings * (1 + RULES.INTEREST)).toLocaleString()}</span>
                            <div style="color:#666;font-size:0.9em;margin-top:6px;">
                                Principal: K${(member.savings || 0).toLocaleString()}<br>
                                Interest: K${((member.savings || 0) * RULES.INTEREST).toFixed(2)}
                            </div>
                        </div>
                        <div style="background:#f8fdff;padding:15px;border-radius:10px;">
                            <strong>Your Loan (with interest)</strong><br>
                            <span style="font-size:1.4em;font-weight:bold;color:#f44336;">K${((member.loanPrincipal || 0) * (1 + RULES.INTEREST)).toLocaleString()}</span>
                            <div style="color:#666;font-size:0.9em;margin-top:6px;">
                                Principal: K${(member.loanPrincipal || 0).toLocaleString()}<br>
                                Interest Due: K${loanInterestDue.toFixed(2)}
                            </div>
                        </div>
                        <div style="background:#f8fdff;padding:15px;border-radius:10px;">
                            <strong>Net Position</strong><br>
                            <span style="font-size:1.4em;font-weight:bold;color:#2e7d32;">K${memberNet.toLocaleString()}</span>
                        </div>
                        <div style="background:#f8fdff;padding:15px;border-radius:10px;">
                            <strong>Pool Payout (10%)</strong><br>
                            <span style="font-size:1.4em;font-weight:bold;color:#1e88e5;">K${memberTakeHome.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <div class="text-center" style="color:#666;padding:40px;">
                        <h3>Member Portal</h3>
                        <p>For transactions and loans, please contact the group administrator.</p>
                    </div>
                </div>
            `;
            updateNetworkStatus();
        }

        // ===== EDIT MEMBER (ADMIN) =====
        function showEditMember(memberId) {
            if (!currentUser || currentUser.type !== 'admin') {
                alert('Only Admins can edit members');
                return;
            }
            
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            document.getElementById('contentArea').innerHTML = `
                <div class="member-card">
                    <h3>‚úèÔ∏è Edit ${member.name}</h3>
                    <input type="text" id="editName" value="${member.name}" placeholder="Full Name">
                    <input type="tel" id="editPhone" value="${member.phone || ''}" placeholder="Phone Number">
                    <input type="text" id="editPin" value="${member.pin || ''}" placeholder="PIN (4+ digits)">
                    <input type="number" id="editSavings" value="${member.savings || 0}" min="0" placeholder="Savings">
                    <input type="number" id="editLoan" value="${member.loanPrincipal || 0}" min="0" placeholder="Loan Principal">
                    
                    <div style="display:flex;gap:20px;margin:15px 0;">
                        <label style="display:flex;align-items:center;">
                            <input id="editMembership" type="checkbox" ${member.membershipPaid ? 'checked' : ''}> Membership paid
                        </label>
                        <label style="display:flex;align-items:center;">
                            <input id="editSocial" type="checkbox" ${member.socialPaid ? 'checked' : ''}> Social paid
                        </label>
                    </div>
                    
                    <div style="display:flex;gap:10px;margin-top:20px;">
                        <button class="btn" onclick="saveEditedMember('${member.id}')">üíæ Save</button>
                        <button class="btn" onclick="resetPin('${member.id}')" style="background:#ff9800;">üîê Reset PIN</button>
                        <button class="btn" onclick="showAllMembers()" style="background:#666;">‚Ü©Ô∏è Cancel</button>
                    </div>
                </div>
            `;
        }

        async function saveEditedMember(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            const name = document.getElementById('editName').value.trim();
            const phone = document.getElementById('editPhone').value.trim();
            const pin = document.getElementById('editPin').value.trim();
            const savings = parseFloat(document.getElementById('editSavings').value) || 0;
            const loan = parseFloat(document.getElementById('editLoan').value) || 0;
            const membershipPaid = document.getElementById('editMembership').checked;
            const socialPaid = document.getElementById('editSocial').checked;
            
            if (!name) {
                alert('Enter a name');
                return;
            }
            
            const changes = {
                name,
                phone,
                pin,
                savings,
                loanPrincipal: loan,
                membershipPaid,
                socialPaid
            };
            
            Object.assign(member, changes);
            localStorage.setItem('members', JSON.stringify(members));
            
            if (!navigator.onLine) {
                enqueueEdit({ type: 'edit-member', memberId, changes, ts: Date.now() });
                showToast('Saved locally; will sync when online');
            } else {
                await saveMembers();
                showToast('Member saved');
            }
            
            showAllMembers();
        }

        async function resetPin(memberId) {
            if (!currentUser || currentUser.type !== 'admin') {
                alert('Only admins can reset PINs');
                return;
            }
            
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            if (!confirm(`Reset PIN for ${member.name} to last 4 digits of phone?`)) return;
            
            member.pin = (member.phone || '').slice(-4);
            localStorage.setItem('members', JSON.stringify(members));
            
            if (!navigator.onLine) {
                enqueueEdit({ type: 'edit-member', memberId, changes: { pin: member.pin }, ts: Date.now() });
                showToast('PIN reset locally; will sync when online');
            } else {
                await saveMembers();
                showToast('PIN reset');
            }
            
            showAllMembers();
        }

        // ===== EDIT PROFILE (MEMBER) =====
        function showEditProfile(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            document.getElementById('app').innerHTML = `
                <div class="header">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <h1>üí∞ SAVERS GROUP</h1>
                            <p>Edit PIN</p>
                        </div>
                        <div id="networkStatus">${navigator.onLine ? 'Online' : 'Offline'}</div>
                    </div>
                </div>
                <div class="content">
                    <div class="member-card">
                        <h3>Change Your PIN</h3>
                        <p style="color:#666;">Your current PIN is the last 4 digits of your phone (${member.phone ? member.phone.slice(-4) : '----'}) unless you set a custom PIN.</p>
                        <input type="password" id="editPin" placeholder="New 4-digit PIN" maxlength="8">
                        <div style="display:flex;gap:10px;margin-top:20px;">
                            <button class="btn" onclick="saveProfilePin('${member.id}')">üíæ Save PIN</button>
                            <button class="btn" onclick="showMemberDashboard('${member.id}')" style="background:#666;">‚Ü©Ô∏è Back</button>
                        </div>
                    </div>
                </div>
            `;
            updateNetworkStatus();
        }

        async function saveProfilePin(memberId) {
            const member = members.find(m => m.id === memberId);
            if (!member) return;
            
            const pin = document.getElementById('editPin').value.trim();
            if (!pin || pin.length < 4) {
                alert('Enter a PIN of at least 4 characters');
                return;
            }
            
            member.pin = pin;
            localStorage.setItem('members', JSON.stringify(members));
            
            if (!navigator.onLine) {
                enqueueEdit({ type: 'edit-member', memberId, changes: { pin }, ts: Date.now() });
                showToast('PIN saved locally; will sync when online');
            } else {
                await saveMembers();
                showToast('PIN saved');
            }
            
            showMemberDashboard(memberId);
        }

        // ===== METRICS UPDATE =====
        function updateAdminMetrics() {
            const elMembers = document.getElementById('metricMembers');
            const elSavings = document.getElementById('metricSavings');
            const elLoans = document.getElementById('metricLoans');
            const elActive = document.getElementById('metricActive');
            
            if (!elMembers) return;
            
            const totalSavings = members.reduce((sum, m) => sum + (m.savings || 0), 0);
            const totalLoans = members.reduce((sum, m) => sum + ((m.loanPrincipal || 0) * (1 + RULES.INTEREST)), 0);
            const active = members.filter(m => m.membershipPaid && m.socialPaid).length;
            
            elMembers.textContent = members.length;
            elSavings.textContent = 'K' + totalSavings.toLocaleString();
            elLoans.textContent = 'K' + totalLoans.toLocaleString();
            elActive.textContent = active;
        }

        // ===== INITIALIZATION =====
        (async () => {
            await loadMembers();
            updateNetworkStatus();
            setInterval(() => {
                if (navigator.onLine) processQueue();
                updateNetworkStatus();
            }, 30000);
        })();
    </script>
</body>
</html>